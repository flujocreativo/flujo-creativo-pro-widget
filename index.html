<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Notion Grid Widget</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<script src="https://animatedicons.co/scripts/embed-animated-icons.js"></script>

<style>
  :root{
    --bg:#fff; --text:#111; --muted:#f7f7f7; --border:#e5e7eb; --blue:#1B4B91;
    --container:936px; --gap:1px;
    --ui-font:13px; --ui-pad-y:8px; --ui-pad-x:12px; --ui-radius:14px;
    --dd-minw:140px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  .wrap{max-width:var(--container);margin:0 auto;padding:14px}

  /* === Unified SVG icons (toolbar) === */
  .icon{
    width:20px;height:20px;display:block;
    color:#111;
  }
  .icon *{ fill: currentColor; }

  /* Toolbar layout (2 rows) */
  .toolbar{
    display:flex;flex-direction:column;gap:10px;
    border-bottom:1px solid var(--border);
    padding-bottom:10px;margin-bottom:10px;
    align-items:center;
  }
  .toolbar-row{
    display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    justify-content:center;
  }
  .toolbar-row.views{gap:22px}

  .btn{
    border:1px solid var(--border);background:#111;color:#fff;
    padding:var(--ui-pad-y) var(--ui-pad-x);font-weight:700;cursor:pointer;
    border-radius:10px;font-size:var(--ui-font);display:inline-flex;align-items:center;gap:8px;
  }
  .btn-icon{
    width:36px;height:36px;border:2px solid var(--border);background:#fff;
    border-radius:12px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;
    font-size:16px;
  }
  .btn-icon .icon{width:18px;height:18px}

  /* View tabs (underline active, like your screenshot) */
  .view-tab{
    width:44px;height:44px;
    border:none;background:transparent;
    display:inline-flex;align-items:center;justify-content:center;
    cursor:pointer;
    color:#111;
    border-radius:12px;
    position:relative;
    transition:transform .12s ease, opacity .12s ease;
    opacity:.92;
  }
  .view-tab:hover{opacity:1;transform:translateY(-1px)}
  .view-tab.active::after{
    content:"";
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:2px;
    width:22px;
    height:2px;
    background:#111;
    border-radius:999px;
  }
  .view-tab .icon{width:20px;height:20px}

  /* Filters */
  .filters-row{
    display:none;gap:10px;align-items:center;justify-content:center;
    padding:6px 0 12px;border-bottom:1px solid var(--border);margin-bottom:10px;
  }
  .filters-row.open{display:flex}

  .dd{position:relative}
  .dd-toggle{
    border:2px solid var(--border);background:#f6f6f6;padding:var(--ui-pad-y) var(--ui-pad-x);
    min-width:var(--dd-minw);max-width:200px;cursor:pointer;display:inline-flex;
    justify-content:space-between;align-items:center;gap:8px;border-radius:var(--ui-radius);
    font-weight:600;font-size:var(--ui-font);white-space:nowrap
  }
  .dd-toggle .label-clip{overflow:hidden;text-overflow:ellipsis}
  .dd-toggle .count{color:#999;margin-left:6px;font-size:12px;flex-shrink:0}
  .dd-menu{
    position:absolute;top:calc(100% + 8px);left:0;min-width:100%;background:#fff;border:1px solid var(--border);
    box-shadow:0 8px 24px rgba(0,0,0,.12);display:none;z-index:30;border-radius:12px;padding:6px
  }
  .dd.open .dd-menu{display:block}
  .dd-item{padding:8px 10px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px;border-radius:8px}
  .dd-item:hover{background:#f9fafb}
  .dd-item .radio{width:16px;height:16px;border:2px solid #ddd;border-radius:50%;position:relative;flex-shrink:0}
  .dd-item.active .radio{border-color:#111}
  .dd-item.active .radio::after{
    content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:7px;height:7px;background:#111;border-radius:50%;
  }
  .dd-item .label{flex:1}
  .dd-item .count{color:#999;font-size:12px}

  /* Menu */
  .menu{position:relative}
  .menu-panel{
    position:absolute;right:0;top:calc(100% + 8px);min-width:260px;background:#fff;border:1px solid var(--border);
    box-shadow:0 8px 24px rgba(0,0,0,.12);display:none;z-index:40;border-radius:12px;padding:10px
  }
  .menu.open .menu-panel{display:block}
  .menu-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;cursor:pointer}
  .menu-row:hover{background:#f9fafb}
  .switch{position:relative;width:42px;height:22px;background:#ddd;cursor:pointer;border-radius:12px}
  .switch::after{
    content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;
    transition:transform .18s;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.2)
  }
  .switch.on{background:#111}
  .switch.on::after{transform:translateX(20px)}
  .menu-note{
    color:#6b7280;font-size:12px;padding:8px 0;margin-top:8px;
    border-top:1px solid var(--border);line-height:1.4;
  }

  /* Bio */
  .bio{
    display:none;border:1px solid var(--border);padding:14px;margin:10px 0 12px;border-radius:12px;
  }
  .bio.visible{display:block}
  .bio-top{
    display:grid;grid-template-columns:56px 1fr;gap:10px;
    align-items:center;margin-bottom:4px;
  }
  .bio-avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;background:#eee}
  .bio-username{font-weight:800;font-size:16px}
  .bio-name{font-weight:600;margin-top:3px;font-size:14px;white-space:nowrap}
  .bio-lines{white-space:pre-wrap;margin:8px 0;line-height:1.45;font-size:14px}
  .bio-link a{color:#1B4B91;text-decoration:none;font-weight:600;font-size:14px}

  /* Grid */
  .grid{
    display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap);margin-top:0;
  }
  .card{
    position:relative;background:#f5f5f5;cursor:pointer;overflow:hidden;
    aspect-ratio:4/5;transition:opacity .2s,transform .2s;
  }
  .card-img,.card-video{width:100%;height:100%;object-fit:cover;display:block;}
  .card-video{pointer-events:none}
  .card-video::-webkit-media-controls-enclosure,
  .card-video::-webkit-media-controls{display:none !important;}

  .badge{
    position:absolute;top:6px;right:6px;z-index:2;display:flex;gap:6px;align-items:center;
  }
  .badge i{
    font-size:13px;color:#fff;filter:drop-shadow(0 1px 2px rgba(0,0,0,.65));
  }
  .badge .fa-play{font-size:12px;opacity:.95}

  .card-overlay{
    position:absolute;bottom:0;left:0;right:0;
    background:linear-gradient(to top, rgba(0,0,0,.55) 0%, transparent 100%);
    padding:8px;display:flex;justify-content:space-between;align-items:flex-end;
    color:#fff;
    opacity:0;transition: opacity .18s ease;
  }
  .card:hover .card-overlay{opacity:1}
  .card-title{font-weight:600;font-size:12px;text-shadow:0 1px 2px rgba(0,0,0,0.5);}
  .card-title:empty{display:none;}
  .card-date{font-size:11px;text-shadow:0 1px 2px rgba(0,0,0,0.5);}
  .card-placeholder{
    display:flex;align-items:center;justify-content:center;
    color:#aaa;font-size:14px;font-weight:500;
  }

  /* Drag & drop visual */
  .card.dragging{outline:2px solid #fff;outline-offset:-2px;cursor:grabbing;}

  /* Skeleton */
  .card.skel{background:#f3f4f6;cursor:default}
  .card.skel::before{
    content:"";position:absolute;inset:0;
    background:linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
    animation:pulse 1.4s ease-in-out infinite;
  }
  @keyframes pulse{0%{transform:translateX(-20%);}50%{transform:translateX(0);}100%{transform:translateX(20%);} }

  /* Modal */
  .modal{
    position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;
    align-items:center;justify-content:center;z-index:50;padding:20px;
  }
  .modal.open{display:flex}
  .modal-close{
    position:absolute;top:20px;right:20px;width:40px;height:40px;
    background:rgba(255,255,255,0.9);border:none;border-radius:50%;cursor:pointer;
    font-size:24px;font-weight:bold;display:flex;align-items:center;justify-content:center;color:#111;
  }
  .modal-content{
    max-width:90vw;max-height:90vh;display:flex;
    flex-direction:column;align-items:center;gap:12px;
  }
  .media-wrap{
    position:relative;max-width:90vw;max-height:80vh;
    display:flex;align-items:center;justify-content:center;
  }
  .modal-media{
    max-width:90vw;max-height:80vh;object-fit:contain;
    box-shadow:0 8px 32px rgba(0,0,0,.4);
  }
  .modal-caption{
    color:#fff;font-size:14px;line-height:1.5;
    max-width:600px;text-align:center;padding:0 20px;
  }

  .nav-btn{
    position:absolute;top:50%;transform:translateY(-50%);
    width:40px;height:40px;border:none;border-radius:999px;
    background:rgba(255,255,255,.85);display:flex;align-items:center;justify-content:center;
    cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.25);opacity:.85;transition:opacity .15s;
  }
  .nav-btn:hover{opacity:1}
  .nav-btn.prev{left:8px}
  .nav-btn.next{right:8px}
  .nav-btn[disabled]{visibility:hidden}
  .zone{position:absolute;top:0;bottom:0;width:30%;pointer-events:auto;background:transparent}
  .zone.prev{left:0}
  .zone.next{right:0}

  .modal-pager{
    display:flex;align-items:center;justify-content:center;gap:10px;
    margin-top:8px;padding:6px 14px;border-radius:999px;background:rgba(0,0,0,.55);
  }
  .modal-counter{color:#fff;font-size:12px;opacity:.85;}
  .modal-dots{display:flex;gap:6px;justify-content:center;}
  .modal-dot{
    width:7px;height:7px;border-radius:999px;background:rgba(255,255,255,.35);
    cursor:pointer;transition:transform .15s ease, background .15s ease, opacity .15s ease, width .15s ease;
    opacity:.7;
  }
  .modal-dot.active{width:16px;background:#fff;opacity:1;transform:translateY(-1px);}

  /* Load more / less */
  .pager-row{display:flex;justify-content:center;gap:8px;margin:10px 0 0;}
  .pager-row .btn{font-size:12px;padding:6px 10px;border-radius:999px;}

  /* Tooltip (clarito tipo Notion) */
  .tip{
    position:fixed;
    z-index:9999;
    display:none;
    pointer-events:none;
    background:#fff;
    border:1px solid #e6e7eb;
    box-shadow:0 10px 30px rgba(0,0,0,.10);
    border-radius:10px;
    padding:8px 10px;
    font-size:12px;
    color:#111;
    line-height:1.2;
    max-width:220px;
  }
  .tip.show{display:block}
  .tip .t{font-weight:600}
  .tip .s{margin-top:3px;color:#6b7280;font-weight:500}

  @media (hover:hover){
    .nav-btn{opacity:0}
    .media-wrap:hover .nav-btn{opacity:.95}
  }
  @media (max-width:640px){
    :root{ --ui-font:12px; --ui-pad-y:7px; --ui-pad-x:10px; --ui-radius:12px; }
    .wrap{padding:12px}
    .bio-top{grid-template-columns:52px 1fr}
    .bio-avatar{width:52px;height:52px}
    .nav-btn{opacity:1}
  }

  /* Readonly */
  .ro .menu { display:none; }
</style>
</head>

<body>
<main class="wrap">
  <div class="toolbar">
    <!-- ROW 1 -->
    <div class="toolbar-row">
      <button id="btnRefresh" class="btn" data-tip="Refresh" data-sub="Update content">
        <animated-icons id="aiRefresh"
          src="https://animatedicons.co/get-icon?name=Restart&style=minimalistic&token=13c130bf-0940-48c2-92e3-16b6ffe3b232"
          trigger="click"
          attributes='{"variationThumbColour":"#FFFFFF","variationName":"Normal","variationNumber":1,"numberOfGroups":1,"backgroundIsGroup":false,"strokeWidth":1.48,"defaultColours":{"group-1":"#FFFFFFFF","background":"#FFFFFF"}}'
          height="18" width="18"></animated-icons>
        Refresh
      </button>

      <!-- Filter icon (normalized via CSS + currentColor) -->
      <button id="btnFilter" class="btn-icon" data-tip="Filter" data-sub="Platforms & status" aria-label="Filter">
        <svg class="icon" viewBox="0 0 214 325" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M52.2841 61.6897H161.716C168.434 61.6897 173.875 70.0027 173.875 76.736C173.875 85.049 168.434 91.7823 161.716 91.7823H52.2841C45.5662 91.7823 40.125 83.4693 40.125 76.736C40.125 68.423 45.5662 61.6897 52.2841 61.6897Z"/>
          <path d="M52.2841 129.398H161.716C168.434 129.398 173.875 137.711 173.875 144.444C173.875 152.758 168.434 159.491 161.716 159.491H52.2841C45.5662 159.491 40.125 151.178 40.125 144.444C40.125 136.131 45.5662 129.398 52.2841 129.398Z"/>
          <path d="M52.2841 197.106H161.716C168.434 197.106 173.875 205.419 173.875 212.153C173.875 220.466 168.434 227.199 161.716 227.199H52.2841C45.5662 227.199 40.125 218.886 40.125 212.153C40.125 203.84 45.5662 197.106 52.2841 197.106Z"/>
        </svg>
      </button>

      <div class="menu" id="menu">
        <!-- Menu icon (3 dots) -->
        <button id="btnMenu" class="btn-icon" data-tip="Options" data-sub="Bio & settings" aria-label="Options">
          <svg class="icon" viewBox="0 0 90 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M11.875 23.75C18.4334 23.75 23.75 18.4334 23.75 11.875C23.75 5.31662 18.4334 0 11.875 0C5.31662 0 0 5.31662 0 11.875C0 18.4334 5.31662 23.75 11.875 23.75Z"/>
            <path d="M78.125 23.75C84.6834 23.75 90 18.4334 90 11.875C90 5.31662 84.6834 0 78.125 0C71.5666 0 66.25 5.31662 66.25 11.875C66.25 18.4334 71.5666 23.75 78.125 23.75Z"/>
            <path d="M45 23.75C51.5584 23.75 56.875 18.4334 56.875 11.875C56.875 5.31662 51.5584 0 45 0C38.4416 0 33.125 5.31662 33.125 11.875C33.125 18.4334 38.4416 23.75 45 23.75Z"/>
          </svg>
        </button>

        <div class="menu-panel">
          <div class="menu-row" id="rowBio">
            <span style="font-weight:600">Show Bio</span>
            <div id="switchBio" class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
          </div>
          <div class="menu-note">
            Want to customize your bio or story highlights? Visit your account page and edit your widget settings there.
          </div>
        </div>
      </div>
    </div>

    <!-- ROW 2 (tabs) -->
    <div class="toolbar-row views">
      <!-- Grid -->
      <button id="btnViewGrid" class="view-tab active" data-tip="Grid" data-sub="Published content grid" aria-label="Grid view">
        <svg class="icon" viewBox="0 0 232 238" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M197.075 0H34.7727C15.5826 0.0222236 0.0222545 15.9334 0 35.5556V201.512C0.0217343 221.134 15.5826 237.045 34.7727 237.067H197.075C216.265 237.045 231.826 221.134 231.848 201.512V35.5556C231.826 15.9334 216.265 0.0227556 197.075 0ZM92.7347 142.234V94.8338H139.113V142.245L92.7347 142.234ZM139.113 165.934V213.356H92.7347V165.945L139.113 165.934ZM23.1892 94.8338H69.5455V142.245L23.1892 142.234V94.8338ZM92.7347 71.1339V23.7113H139.113L139.102 71.1225L92.7347 71.1339ZM162.291 94.8338H208.659V142.245H162.291V94.8338ZM208.659 35.5669L208.648 71.1225H162.28L162.291 23.7113H197.064C203.464 23.7113 208.659 29.0113 208.659 35.5558V35.5669ZM34.7727 23.7113H69.5455V71.1225H23.1892V35.5556C23.1892 29.0111 28.3723 23.7113 34.7727 23.7113ZM23.189 201.512V165.945H69.5452V213.367L34.7724 213.356C28.372 213.356 23.189 208.056 23.189 201.512ZM197.075 213.367H162.302V165.945H208.669V201.512H208.659C208.659 208.056 203.475 213.356 197.075 213.356L197.075 213.367Z"/>
        </svg>
      </button>

      <!-- Reels -->
      <button id="btnViewReels" class="view-tab" data-tip="Reels" data-sub="Videos only" aria-label="Reels view">
        <svg class="icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M502.08 127.37C492 70.4601 441.54 20.0001 384.63 9.92006H384.44C344.75 3.28007 302.74 0.0500649 256 6.48682e-05C209.26 -0.0499351 167.24 3.29007 127.56 9.89007H127.37C70.47 20.0001 20 70.4701 9.93 127.37C9.92431 127.433 9.92431 127.497 9.93 127.56C3.3 167.24 0.0599961 209.24 -3.85515e-06 256C-0.0600039 302.76 3.3 344.79 9.89 384.45C9.88533 384.51 9.88533 384.57 9.89 384.63C20 441.53 70.47 492 127.37 502.08H127.56C167.26 508.68 209.27 511.92 256.03 511.97C302.79 512.02 344.75 508.68 384.45 502.08H384.64C441.54 492 492 441.53 502.08 384.63V384.44C508.71 344.77 512 302.76 512 256C512 209.24 508.71 167.26 502.11 127.58L502.08 127.37ZM416 63.0701C435.43 76.0701 451.38 95.2601 459.69 116.53C430.69 113.22 400.94 110.68 370.19 108.88L416 63.0701ZM378 47.3401L318.74 106.6C299.04 105.993 278.867 105.66 258.22 105.6L323.22 40.6001C342.14 42.1901 360.34 44.4101 378 47.3401ZM256 38.0001C261.4 38.0001 266.733 38.0501 272 38.1501L203.87 106.28C184.85 106.747 166.25 107.48 148.07 108.48L217.71 38.8401C230.097 38.2801 242.86 38.0001 256 38.0001ZM133.89 47.3601C142.163 45.9801 150.557 44.7601 159.07 43.7001L91.59 111.18C91.1363 111.635 90.7057 112.112 90.3 112.61C86.0933 112.983 81.9 113.37 77.72 113.77C77.1 113.83 76.49 113.92 75.88 114.04C75.8036 114.049 75.7264 114.049 75.65 114.04C74.98 114.04 74.35 114.04 73.65 114.13C66.5567 114.837 59.4367 115.603 52.29 116.43C65.66 82.4301 98.58 53.6401 133.89 47.3601ZM464.64 378.11C457.32 419.33 419.34 457.31 378.12 464.64C340.52 470.89 300.57 474 256 474C211.43 474 171.47 470.89 133.87 464.64C92.65 457.31 54.67 419.33 47.34 378.1C41.12 340.55 38.06 300.6 38 256C37.8795 222.467 39.9237 188.96 44.12 155.69C54.97 154.35 65.85 153.13 76.63 152.05C78.4841 152 80.3322 151.816 82.16 151.5C136.6 146.24 193.37 143.66 255.64 143.6C332.53 143.67 402.12 147.6 467.87 155.75C472.07 189 474.118 222.486 474 256C474 300.58 470.89 340.53 464.64 378.11Z"/>
          <path d="M342.41 285.08C328.41 276.69 314.15 267.33 300.33 258.28C294.83 254.69 289.38 251.11 283.98 247.63C267.79 237.15 246.66 223.9 226.69 214.24C216.57 209.3 204.4 209.91 193.29 215.92C178.99 223.65 168.52 238.59 166.62 253.99V254.31C165.09 268.73 164.04 283.21 163.51 297.31C163.505 297.397 163.505 297.483 163.51 297.57C163.51 298.04 163.24 309.21 163.24 319.57C163.24 329.93 163.5 341.11 163.51 341.57C163.505 341.657 163.505 341.743 163.51 341.83C164.04 355.94 165.09 370.42 166.62 384.83V385.15C168.52 400.55 178.99 415.49 193.29 423.22C199.056 426.429 205.532 428.147 212.13 428.22C217.165 428.269 222.145 427.168 226.69 425C246.69 415.34 267.8 402.09 283.97 391.63C289.377 388.13 294.83 384.573 300.33 380.96C314.15 371.91 328.45 362.56 342.41 354.16H342.47C355.21 346.44 362.81 333.55 362.81 319.67C362.81 305.79 355.21 292.83 342.41 285.08ZM322.81 321.58C308.23 330.35 293.63 339.9 279.52 349.14C274.093 352.693 268.697 356.21 263.33 359.69C248.49 369.29 229.33 381.34 211.61 390.04C208.96 388.82 204.88 384.39 204.35 380.69C202.93 367.22 201.96 353.69 201.46 340.58C201.46 339.31 201.2 328.93 201.2 319.58C201.2 310.23 201.43 299.87 201.46 298.58C201.96 285.43 202.93 271.94 204.35 258.48C204.88 254.78 208.96 250.34 211.61 249.12C229.3 257.81 248.48 269.87 263.34 279.49C268.69 282.94 274.09 286.49 279.52 290.03C293.64 299.27 308.25 308.83 322.78 317.57C324.39 318.57 324.78 319.4 324.78 319.57C324.78 319.74 324.39 320.62 322.81 321.58Z"/>
        </svg>
      </button>

      <!-- Drafts -->
      <button id="btnViewDrafts" class="view-tab" data-tip="Drafts" data-sub="Status = Draft" aria-label="Drafts view">
        <svg class="icon" viewBox="0 0 69 69" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0.000900269 16.664C0.000900269 7.4609 7.4697 0 16.6809 0H52.1969C61.4078 0 68.8769 7.4609 68.8769 16.664C68.8769 18.0468 67.7597 19.1718 66.3691 19.1718H2.5101C1.1273 19.1718 0.00230026 18.0468 0.00230026 16.664H0.000900269ZM64.7119 29.586C67.0088 29.586 68.876 31.4532 68.876 33.7579V52.2029C68.876 61.406 61.4072 68.8669 52.196 68.8669H16.68C7.4691 68.8669 0 61.406 0 52.2029V33.7579C0 31.4532 1.8672 29.586 4.1719 29.586H15.7269C18.0238 29.586 19.805 31.5626 20.9066 33.5782C22.3285 36.1563 25.0707 37.9063 28.2269 37.9063H40.6649C43.8133 37.9063 46.5633 36.1563 47.9774 33.5782C49.0868 31.5626 50.8602 29.586 53.1649 29.586H64.7119Z"/>
        </svg>
      </button>
    </div>
  </div>

  <div id="filtersRow" class="filters-row">
    <div class="dd" id="ddPlatforms">
      <button class="dd-toggle" id="togglePlatforms">
        <span class="label-clip" id="labelPlatforms">All Platforms</span>
        <span><span id="countPlatforms" class="count"></span> ▾</span>
      </button>
      <div class="dd-menu" id="menuPlatforms"></div>
    </div>

    <div class="dd" id="ddStatus">
      <button class="dd-toggle" id="toggleStatus">
        <span class="label-clip" id="labelStatus">All Status</span>
        <span><span id="countStatus" class="count"></span> ▾</span>
      </button>
      <div class="dd-menu" id="menuStatus"></div>
    </div>
  </div>

  <section id="bio" class="bio visible" aria-hidden="false">
    <div class="bio-top">
      <img id="bioAvatar" class="bio-avatar" alt="" style="display:none" />
      <div>
        <div id="bioUsername" class="bio-username"></div>
        <div id="bioName" class="bio-name"></div>
      </div>
    </div>
    <div id="bioLines" class="bio-lines"></div>
    <div class="bio-link"><a id="bioUrl" href="#" target="_blank" rel="noopener"></a></div>
  </section>

  <section id="grid" class="grid" aria-live="polite"></section>

  <div class="pager-row" id="pagerRow">
    <button id="btnLess" class="btn" style="display:none;">Show less</button>
    <button id="btnMore" class="btn" style="display:none;">Load more</button>
  </div>
</main>

<div id="modal" class="modal" aria-hidden="true">
  <button class="modal-close" id="modalClose">×</button>
  <div class="modal-content">
    <div id="mediaWrap" class="media-wrap">
      <div id="modalMedia"></div>
      <button id="btnPrev" class="nav-btn prev" aria-label="Previous">‹</button>
      <button id="btnNext" class="nav-btn next" aria-label="Next">›</button>
      <div id="zonePrev" class="zone prev" aria-hidden="true"></div>
      <div id="zoneNext" class="zone next" aria-hidden="true"></div>
    </div>

    <div id="modalPager" class="modal-pager">
      <div id="modalDots" class="modal-dots"></div>
      <div id="modalCounter" class="modal-counter"></div>
    </div>

    <div id="modalCaption" class="modal-caption"></div>
  </div>
</div>

<!-- tooltip -->
<div id="tip" class="tip" role="tooltip" aria-hidden="true">
  <div class="t" id="tipT"></div>
  <div class="s" id="tipS"></div>
</div>

<script>
  const READONLY = new URLSearchParams(window.location.search).get("readonly") === "1";
  if (READONLY) document.body.classList.add("ro");

  const BASE_LIMIT = 12;

  const state = {
    dbId: null,
    items: [],
    selectedPlatform: null,
    selectedStatus: null,
    bio: null,
    showBio: true,
    viewMode: "grid", // "grid" | "reels" | "drafts"
    modalAssets: [],
    modalIndex: 0,
    modalCaption: "",
    visibleCount: BASE_LIMIT
  };

  // DOM refs
  const $grid = document.getElementById("grid");
  const $btnRefresh = document.getElementById("btnRefresh");
  const $btnFilter = document.getElementById("btnFilter");
  const $filtersRow = document.getElementById("filtersRow");

  const $ddPlatforms = document.getElementById("ddPlatforms");
  const $togglePlatforms = document.getElementById("togglePlatforms");
  const $menuPlatforms = document.getElementById("menuPlatforms");
  const $labelPlatforms = document.getElementById("labelPlatforms");
  const $countPlatforms = document.getElementById("countPlatforms");

  const $ddStatus = document.getElementById("ddStatus");
  const $toggleStatus = document.getElementById("toggleStatus");
  const $menuStatus = document.getElementById("menuStatus");
  const $labelStatus = document.getElementById("labelStatus");
  const $countStatus = document.getElementById("countStatus");

  const $menu = document.getElementById("menu");
  const $btnMenu = document.getElementById("btnMenu");
  const $rowBio = document.getElementById("rowBio");
  const $switchBio = document.getElementById("switchBio");

  const $bio = document.getElementById("bio");
  const $bioUsername = document.getElementById("bioUsername");
  const $bioName = document.getElementById("bioName");
  const $bioLines = document.getElementById("bioLines");
  const $bioUrl = document.getElementById("bioUrl");
  const $bioAvatar = document.getElementById("bioAvatar");

  const $modal = document.getElementById("modal");
  const $mediaWrap = document.getElementById("mediaWrap");
  const $modalMedia = document.getElementById("modalMedia");
  const $modalPager = document.getElementById("modalPager");
  const $modalDots = document.getElementById("modalDots");
  const $modalCounter = document.getElementById("modalCounter");
  const $modalCaption = document.getElementById("modalCaption");
  const $modalClose = document.getElementById("modalClose");
  const $btnPrev = document.getElementById("btnPrev");
  const $btnNext = document.getElementById("btnNext");
  const $zonePrev = document.getElementById("zonePrev");
  const $zoneNext = document.getElementById("zoneNext");

  const $aiRefresh = document.getElementById("aiRefresh");

  const $btnViewGrid = document.getElementById("btnViewGrid");
  const $btnViewReels = document.getElementById("btnViewReels");
  const $btnViewDrafts = document.getElementById("btnViewDrafts");

  const $btnMore = document.getElementById("btnMore");
  const $btnLess = document.getElementById("btnLess");

  /* Tooltip wiring */
  const $tip = document.getElementById("tip");
  const $tipT = document.getElementById("tipT");
  const $tipS = document.getElementById("tipS");

  function showTip(el){
    const t = el.getAttribute("data-tip");
    if (!t) return;
    const s = el.getAttribute("data-sub") || "";
    $tipT.textContent = t;
    $tipS.textContent = s;
    $tip.classList.add("show");
    $tip.setAttribute("aria-hidden","false");
  }
  function moveTip(e){
    const pad = 12;
    const x = (e.clientX ?? 0) + pad;
    const y = (e.clientY ?? 0) + pad;
    $tip.style.left = x + "px";
    $tip.style.top  = y + "px";
  }
  function hideTip(){
    $tip.classList.remove("show");
    $tip.setAttribute("aria-hidden","true");
  }
  function bindTip(el){
    el.addEventListener("mouseenter", () => showTip(el));
    el.addEventListener("mousemove", moveTip);
    el.addEventListener("mouseleave", hideTip);
  }
  // bind tooltips to key controls
  [$btnRefresh,$btnFilter,$btnMenu,$btnViewGrid,$btnViewReels,$btnViewDrafts].forEach(b => b && bindTip(b));

  function formatDate(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d)) return "";
    return d.toLocaleDateString("en-US",{month:"short",day:"numeric"});
  }

  function setSwitch(el,on){
    el.classList.toggle("on", !!on);
    el.setAttribute("aria-checked", !!on);
  }

  function renderSkeleton(){
    const n = 9;
    $grid.innerHTML = Array.from({length:n}).map(() => '<div class="card skel"></div>').join("");
  }

  function passPlatform(it){
    return !state.selectedPlatform || it.platform === state.selectedPlatform;
  }
  function passStatus(it){
    return !state.selectedStatus || it.status === state.selectedStatus;
  }

  function isDraft(it){
    if (!it || !it.status) return false;
    return it.status === "Draft" || it.status === "Borrador";
  }

  function passViewMode(it){
    // readonly: nunca mostrar drafts
    if (READONLY && isDraft(it)) return false;

    if (state.viewMode === "reels"){
      // solo videos, NO drafts
      return !!it.isVideo && !isDraft(it);
    }
    if (state.viewMode === "drafts"){
      // solo drafts
      return isDraft(it);
    }
    // grid: solo NO drafts
    return !isDraft(it);
  }

  function passFilters(it){
    return passPlatform(it) && passStatus(it) && passViewMode(it);
  }

  function renderBio(){
    const b = state.bio;
    if (!b || !state.showBio){
      $bio.classList.remove("visible");
      $bio.setAttribute("aria-hidden","true");
      return;
    }
    $bioUsername.textContent = b.username || "";
    $bioName.textContent = b.name || "";
    $bioLines.textContent = (b.textLines || []).join("\n");
    const cleanUrl = (b.url || "").replace(/^https?:\/\//,"");
    $bioUrl.textContent = cleanUrl || "";
    $bioUrl.href = b.url || "#";

    if (b.avatar){
      $bioAvatar.src = b.avatar;
      $bioAvatar.style.display = "block";
    } else {
      $bioAvatar.style.display = "none";
    }

    $bio.classList.add("visible");
    $bio.setAttribute("aria-hidden","false");
  }

  function toggleBio(){
    state.showBio = !state.showBio;
    try{ localStorage.setItem("showBio", String(state.showBio)); }catch(e){}
    setSwitch($switchBio, state.showBio);
    renderBio();
  }

  function closeDD(){
    $ddPlatforms.classList.remove("open");
    $ddStatus.classList.remove("open");
  }

  function renderMenus(){
    const items = state.items || [];

    const platCounts = {};
    const statusCounts = {};

    items.forEach(it => {
      if (it.platform){
        platCounts[it.platform] = (platCounts[it.platform] || 0) + 1;
      }
      if (it.status){
        statusCounts[it.status] = (statusCounts[it.status] || 0) + 1;
      }
    });

    const platforms = Object.keys(platCounts).sort((a,b) => platCounts[b]-platCounts[a]);
    const statuses  = Object.keys(statusCounts).sort((a,b) => statusCounts[b]-statusCounts[a]);

    const filteredByStatus = items.filter(passStatus);
    const filteredByPlatform = items.filter(passPlatform);

    const allPlatCount = filteredByStatus.length;
    const allStatusCount = filteredByPlatform.length;

    const platMenuItems = ["All Platforms", ...platforms];
    $menuPlatforms.innerHTML = platMenuItems.map(name => {
      const count = name === "All Platforms" ? allPlatCount : (platCounts[name] || 0);
      const active = (name === "All Platforms" && !state.selectedPlatform) || state.selectedPlatform === name;
      return `<div class="dd-item ${active?"active":""}" data-v="${name}">
        <div class="radio"></div>
        <div class="label">${name}</div>
        <div class="count">${count}</div>
      </div>`;
    }).join("");

    Array.from($menuPlatforms.children).forEach(el => {
      el.onclick = () => {
        const val = el.getAttribute("data-v");
        state.visibleCount = BASE_LIMIT;
        state.selectedPlatform = (val === "All Platforms") ? null : val;
        $labelPlatforms.textContent = val;
        renderGrid();
        renderMenus();
        updateCounts();
        closeDD();
      };
    });

    const statusMenuItems = ["All Status", ...statuses];
    $menuStatus.innerHTML = statusMenuItems.map(name => {
      const count = name === "All Status" ? allStatusCount : (statusCounts[name] || 0);
      const active = (name === "All Status" && !state.selectedStatus) || state.selectedStatus === name;
      return `<div class="dd-item ${active?"active":""}" data-v="${name}">
        <div class="radio"></div>
        <div class="label">${name}</div>
        <div class="count">${count}</div>
      </div>`;
    }).join("");

    Array.from($menuStatus.children).forEach(el => {
      el.onclick = () => {
        const val = el.getAttribute("data-v");
        state.visibleCount = BASE_LIMIT;
        state.selectedStatus = (val === "All Status") ? null : val;
        $labelStatus.textContent = val;
        renderGrid();
        renderMenus();
        updateCounts();
        closeDD();
      };
    });

    $labelPlatforms.textContent = state.selectedPlatform || "All Platforms";
    $labelStatus.textContent = state.selectedStatus || "All Status";
  }

  function updateCounts(){
    const filtered = (state.items || []).filter(passFilters);
    const count = filtered.length;
    $countPlatforms.textContent = state.selectedPlatform ? `(${count})` : "";
    $countStatus.textContent = state.selectedStatus ? `(${count})` : "";
  }

  // Persist order in localStorage
  function getOrderKey(){
    if (!state.dbId) return null;
    return `igGridOrder:${state.dbId}`;
  }
  function loadSavedOrder(){
    const key = getOrderKey();
    if (!key) return;
    let raw;
        try{ raw = localStorage.getItem(key); }catch(e){ return; }
    if (!raw) return;

    let ids;
    try{ ids = JSON.parse(raw); }catch(e){ return; }
    if (!Array.isArray(ids) || !ids.length) return;

    const indexById = new Map();
    ids.forEach((id, idx) => indexById.set(id, idx));

    (state.items || []).forEach(it => {
      const id = it._id || it.id;
      if (!id) return;
      if (indexById.has(id)) it._order = indexById.get(id);
    });
  }
  function saveCurrentOrder(){
    if (READONLY) return;
    const key = getOrderKey();
    if (!key) return;
    const ids = (state.items || []).map(it => it._id || it.id).filter(Boolean);
    if (!ids.length) return;
    try{ localStorage.setItem(key, JSON.stringify(ids)); }catch(e){}
  }

  let justReordered = false;

  function applyOrderNumbers(arr){
    arr.forEach((it, i) => { it._order = i; });
  }

  function resortItems(){
    state.items = (state.items || []).slice().sort((a,b) => {
      if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
      const oa = typeof a._order === "number" ? a._order : 0;
      const ob = typeof b._order === "number" ? b._order : 0;
      return oa - ob;
    });
  }

  function reorderByIds(sourceId, targetId){
    if (!sourceId || !targetId || sourceId === targetId) return;
    const arr = (state.items || []).slice();
    const fromIndex = arr.findIndex(x => x._id === sourceId);
    const toIndex = arr.findIndex(x => x._id === targetId);
    if (fromIndex === -1 || toIndex === -1) return;
    const [moved] = arr.splice(fromIndex,1);
    arr.splice(toIndex,0,moved);
    applyOrderNumbers(arr);
    state.items = arr;
    justReordered = true;
    saveCurrentOrder();
    renderGrid();
  }

  function renderGrid(){
    resortItems();

    const allFiltered = (state.items || []).filter(passFilters);
    const total = allFiltered.length;

    const emptyMsg =
      state.viewMode === "reels" ? "No reels with video yet" :
      state.viewMode === "drafts" ? "No drafts yet" :
      "No content";

    if (!total){
      $grid.innerHTML = Array.from({length:BASE_LIMIT})
        .map(() => `<div class="card card-placeholder">${emptyMsg}</div>`)
        .join("");
      $btnMore.style.display = "none";
      $btnLess.style.display = "none";
      return;
    }

    const visible = Math.min(state.visibleCount || BASE_LIMIT, total);
    const items = allFiltered.slice(0, visible);

    const realCardsHtml = items.map((it, idx) => {
      const badges = [];
      if (it.isVideo) badges.push('<i class="fa-solid fa-play" aria-hidden="true" title="Video"></i>');
      if (it.pinned)  badges.push('<i class="fa-solid fa-thumbtack" aria-hidden="true" title="Pinned"></i>');

      const first = (it.assets && it.assets[0]) || null;
      let media = "";

      if (first){
        if (first.type === "video"){
          media = `<video class="card-video" src="${first.url}" muted loop playsinline preload="metadata"></video>`;
        } else {
          media = `<img class="card-img" src="${first.url}" alt="${(it.title || "").replace(/"/g,"&quot;")}" loading="lazy" decoding="async" />`;
        }
      } else {
        media = '<div class="card-placeholder">No Content</div>';
      }

      const titleHtml = it.title ? `<div class="card-title">${it.title}</div>` : '<div class="card-title"></div>';

      return `<article class="card" data-type="real" data-idx="${idx}" data-id="${it._id}">
        <div class="badge">${badges.join("")}</div>
        ${media}
        <div class="card-overlay">
          ${titleHtml}
          <div class="card-date">${formatDate(it.publishDate)}</div>
        </div>
      </article>`;
    }).join("");

    const placeholdersNeeded = total < BASE_LIMIT ? Math.max(0, BASE_LIMIT - items.length) : 0;
    const placeholdersHtml = Array.from({length:placeholdersNeeded})
      .map(() => `<div class="card card-placeholder">${emptyMsg}</div>`)
      .join("");

    $grid.innerHTML = realCardsHtml + placeholdersHtml;

    if (total <= BASE_LIMIT){
      $btnMore.style.display = "none";
      $btnLess.style.display = "none";
    } else {
      $btnMore.style.display = (state.visibleCount >= total) ? "none" : "inline-flex";
      $btnLess.style.display = (state.visibleCount > BASE_LIMIT) ? "inline-flex" : "none";
    }

    const cards = Array.from($grid.querySelectorAll('.card[data-type="real"]'));
    cards.forEach(card => {
      const idx = parseInt(card.getAttribute("data-idx"), 10);
      const item = items[idx];
      const vid = card.querySelector("video.card-video");
      const id = card.getAttribute("data-id");

      const mediaEl = card.querySelector("img.card-img, video.card-video");
      if (mediaEl) mediaEl.draggable = false;

      if (vid){
        card.addEventListener("mouseenter", () => { vid.play().catch(()=>{}); });
        card.addEventListener("mouseleave", () => { vid.pause(); });
      }

      let isPointerDown = false;
      let pointerMoved = false;
      let pointerId = null;
      let startX = 0;
      let startY = 0;
      const DRAG_THRESHOLD = 5;

      card.addEventListener("pointerdown", (e) => {
        if (e.button !== 0 && e.pointerType === "mouse") return;
        isPointerDown = true;
        pointerMoved = false;
        pointerId = e.pointerId;
        startX = e.clientX;
        startY = e.clientY;
        card.setPointerCapture(pointerId);
        card.classList.add("dragging");
      });

      card.addEventListener("pointermove", (e) => {
        if (!isPointerDown) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        if (!pointerMoved && Math.sqrt(dx*dx + dy*dy) > DRAG_THRESHOLD){
          pointerMoved = true;
        }
      });

      function endPointer(e){
        if (!isPointerDown) return;
        isPointerDown = false;
        card.classList.remove("dragging");
        try{ if (pointerId != null) card.releasePointerCapture(pointerId); }catch(_){}
        pointerId = null;

        if (!pointerMoved){
          if (!justReordered){
            openModal(item);
          } else {
            justReordered = false;
          }
          return;
        }

        const clientX = e.clientX;
        const clientY = e.clientY;
        if (clientX == null || clientY == null) return;

        const el = document.elementFromPoint(clientX, clientY);
        const targetCard = el && el.closest('.card[data-type="real"]');
        const targetId = targetCard && targetCard.getAttribute("data-id");
        reorderByIds(id, targetId);
      }

      card.addEventListener("pointerup", endPointer);
      card.addEventListener("pointercancel", endPointer);
    });
  }

  function renderModalDotsAndCounter(){
    const total = state.modalAssets.length;
    $modalDots.innerHTML = "";
    if ($modalCounter) $modalCounter.textContent = "";

    if (!total || total === 1){
      $modalPager.style.display = "none";
      return;
    }
    $modalPager.style.display = "flex";

    const frag = document.createDocumentFragment();
    state.modalAssets.forEach((_, i) => {
      const dot = document.createElement("div");
      dot.className = "modal-dot" + (i === state.modalIndex ? " active" : "");
      dot.addEventListener("click", () => { state.modalIndex = i; renderModalAsset(); });
      frag.appendChild(dot);
    });
    $modalDots.appendChild(frag);
    if ($modalCounter) $modalCounter.textContent = `${state.modalIndex + 1}/${total}`;
  }

  function renderModalAsset(){
    const idx = state.modalIndex;
    const a = state.modalAssets[idx];
    $modalMedia.innerHTML = "";
    if (!a) {
      $modalCaption.textContent = "";
      $btnPrev.disabled = true;
      $btnNext.disabled = true;
      $modalDots.innerHTML = "";
      if ($modalCounter) $modalCounter.textContent = "";
      $modalPager.style.display = "none";
      return;
    }

    if (a.type === "video"){
      const v = document.createElement("video");
      v.src = a.url;
      v.autoplay = true;
      v.muted = true;
      v.playsInline = true;
      v.loop = true;
      v.className = "modal-media";
      $modalMedia.appendChild(v);
    } else {
      const i = document.createElement("img");
      i.src = a.url;
      i.alt = "";
      i.className = "modal-media";
      $modalMedia.appendChild(i);
    }

    $modalCaption.textContent = idx === 0 ? state.modalCaption : "";
    $btnPrev.disabled = idx <= 0;
    $btnNext.disabled = idx >= state.modalAssets.length - 1;
    renderModalDotsAndCounter();
  }

  function openModal(item){
    const assets = (item.assets && item.assets.length) ? item.assets.slice() : [];
    state.modalAssets = assets;
    state.modalIndex = 0;
    state.modalCaption = item.caption || "";
    renderModalAsset();
    $modal.classList.add("open");
    $modal.setAttribute("aria-hidden","false");
  }

  function closeModalFn(){
    $modal.classList.remove("open");
    $modal.setAttribute("aria-hidden","true");
    $modalMedia.innerHTML = "";
    $modalCaption.textContent = "";
    $modalDots.innerHTML = "";
    if ($modalCounter) $modalCounter.textContent = "";
    $modalPager.style.display = "none";
    state.modalAssets = [];
    state.modalIndex = 0;
    state.modalCaption = "";
  }

  $btnPrev.onclick = () => { if (state.modalIndex > 0){ state.modalIndex--; renderModalAsset(); } };
  $btnNext.onclick = () => { if (state.modalIndex < state.modalAssets.length - 1){ state.modalIndex++; renderModalAsset(); } };
  $zonePrev.onclick = $btnPrev.onclick;
  $zoneNext.onclick = $btnNext.onclick;
  $modal.onclick = e => { if (e.target === $modal) closeModalFn(); };
  $modalClose.onclick = closeModalFn;

  document.addEventListener("keydown", e => {
    if (!$modal.classList.contains("open")) return;
    if (e.key === "Escape") closeModalFn();
    if (e.key === "ArrowLeft") $btnPrev.click();
    if (e.key === "ArrowRight") $btnNext.click();
  });

  (function setupSwipe(){
    let startX = null;
    let isTouching = false;

    function onStart(e){
      isTouching = true;
      startX = (e.touches ? e.touches[0].clientX : e.clientX);
    }
    function onEnd(e){
      if (!isTouching || startX == null) return;
      const endX = (e.changedTouches ? e.changedTouches[0].clientX : e.clientX);
      const diff = endX - startX;
      const threshold = 40;

      if (Math.abs(diff) > threshold){
        if (diff < 0) $btnNext.click();
        else $btnPrev.click();
      }
      isTouching = false;
      startX = null;
    }

    $mediaWrap.addEventListener("touchstart", onStart, {passive:true});
    $mediaWrap.addEventListener("touchend", onEnd);

    let mouseDown = false;
    $mediaWrap.addEventListener("mousedown", e => { mouseDown = true; onStart(e); });
    $mediaWrap.addEventListener("mouseup", e => { if (!mouseDown) return; mouseDown = false; onEnd(e); });
    $mediaWrap.addEventListener("mouseleave", () => { mouseDown = false; startX = null; });
  })();

  function updateViewButtons(){
    $btnViewGrid.classList.toggle("active", state.viewMode === "grid");
    $btnViewReels.classList.toggle("active", state.viewMode === "reels");
    if ($btnViewDrafts) $btnViewDrafts.classList.toggle("active", state.viewMode === "drafts");
  }

  function applyReadonlyRules(){
    if (!$btnViewDrafts) return;
    if (READONLY){
      $btnViewDrafts.style.display = "none";
      if (state.viewMode === "drafts") state.viewMode = "grid";
    } else {
      $btnViewDrafts.style.display = "inline-flex";
    }
  }

  $btnViewGrid.onclick = () => {
    state.viewMode = "grid";
    state.visibleCount = BASE_LIMIT;
    updateViewButtons();
    renderGrid();
    updateCounts();
  };
  $btnViewReels.onclick = () => {
    state.viewMode = "reels";
    state.visibleCount = BASE_LIMIT;
    updateViewButtons();
    renderGrid();
    updateCounts();
  };
  if ($btnViewDrafts){
    $btnViewDrafts.onclick = () => {
      if (READONLY) return;
      state.viewMode = "drafts";
      state.visibleCount = BASE_LIMIT;
      updateViewButtons();
      renderGrid();
      updateCounts();
    };
  }

  $btnMore.onclick = () => {
    const totalFiltered = (state.items || []).filter(passFilters).length;
    state.visibleCount = Math.min(totalFiltered, (state.visibleCount || BASE_LIMIT) + 6);
    renderGrid();
  };
  $btnLess.onclick = () => { state.visibleCount = BASE_LIMIT; renderGrid(); };

  function handleRefresh(){
    state.selectedPlatform = null;
    state.selectedStatus = null;
    state.visibleCount = BASE_LIMIT;
    state.viewMode = "grid";
    $labelPlatforms.textContent = "All Platforms";
    $labelStatus.textContent = "All Status";
    closeDD();
    load();
  }

  $btnRefresh.onclick = handleRefresh;
  if ($aiRefresh){
    $aiRefresh.addEventListener("click", function(e){
      e.stopPropagation();
      handleRefresh();
    });
  }

  $btnFilter.onclick = () => {
    const isOpen = $filtersRow.classList.contains("open");
    if (isOpen) $filtersRow.classList.remove("open");
    else $filtersRow.classList.add("open");
  };

  $togglePlatforms.onclick = e => {
    e.stopPropagation();
    $filtersRow.classList.add("open");
    const isOpen = $ddPlatforms.classList.contains("open");
    closeDD();
    if (!isOpen) $ddPlatforms.classList.add("open");
  };

  $toggleStatus.onclick = e => {
    e.stopPropagation();
    $filtersRow.classList.add("open");
    const isOpen = $ddStatus.classList.contains("open");
    closeDD();
    if (!isOpen) $ddStatus.classList.add("open");
  };

  $btnMenu.onclick = e => {
    e.stopPropagation();
    closeDD();
    $menu.classList.toggle("open");
  };

  document.addEventListener("click", e => {
    if (!$menu.contains(e.target)) $menu.classList.remove("open");
    if (!$ddPlatforms.contains(e.target)) $ddPlatforms.classList.remove("open");
    if (!$ddStatus.contains(e.target)) $ddStatus.classList.remove("open");
  });

  $rowBio.onclick = toggleBio;
  $switchBio.onclick = e => { e.stopPropagation(); toggleBio(); };

  async function load(){
    renderSkeleton();
    try{
      const res = await fetch("/api/grid");
      const data = await res.json();
      if (!data || !data.ok){
        console.error("Grid error:", data && data.error);
        $grid.innerHTML = '<div class="card card-placeholder">Error loading grid</div>';
        $btnMore.style.display = "none";
        $btnLess.style.display = "none";
        $modalPager.style.display = "none";
        return;
      }

      state.dbId = data.dbId || null;

      state.items = (data.items || []).map((it, idx) => ({
        ...it,
        _order: typeof it._order === "number" ? it._order : idx,
        _id: it._id || it.id || it.pageId || it.notionId || `local-${idx}`
      }));

      loadSavedOrder();

      state.bio = data.bio || null;

      try{
        state.showBio = (localStorage.getItem("showBio") || "true") === "true";
      }catch(e){
        state.showBio = true;
      }

      setSwitch($switchBio, state.showBio);
      renderBio();
      renderMenus();

      state.visibleCount = BASE_LIMIT;
      applyReadonlyRules();
      updateViewButtons();
      renderGrid();
      updateCounts();
      $modalPager.style.display = "none";
    }catch(e){
      console.error("Load error:", e);
      $grid.innerHTML = '<div class="card card-placeholder">Error loading grid</div>';
      $btnMore.style.display = "none";
      $btnLess.style.display = "none";
      $modalPager.style.display = "none";
    }
  }

  load();
</script>
</body>
</html>
