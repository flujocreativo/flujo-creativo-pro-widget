<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Notion Grid Widget</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<script src="https://animatedicons.co/scripts/embed-animated-icons.js"></script>

<style>
  :root{
    --bg:#fff; --text:#111; --muted:#f7f7f7; --border:#e5e7eb; --blue:#1B4B91;
    --container:936px; --gap:1px;
    --ui-font:13px; --ui-pad-y:8px; --ui-pad-x:12px; --ui-radius:14px;
    --dd-minw:140px;
    --btnSize:36px;
    --shiftX:46px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  .wrap{max-width:var(--container);margin:0 auto;padding:14px}

  /* === Unified SVG icons (toolbar) === */
  .icon{width:20px;height:20px;display:block;color:#111}
  .icon *{ fill: currentColor; }

  /* Toolbar layout (3 rows) */
  .toolbar{
    display:flex;flex-direction:column;gap:10px;
    border-bottom:1px solid var(--border);
    padding-bottom:10px;margin-bottom:10px;
    align-items:center;
  }
  .toolbar-row{
    display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    justify-content:center;
    width:100%;
  }
  .toolbar-row.views{gap:22px}

  .btn{
    border:1px solid var(--border);background:#111;color:#fff;
    padding:var(--ui-pad-y) var(--ui-pad-x);font-weight:700;cursor:pointer;
    border-radius:10px;font-size:var(--ui-font);display:inline-flex;align-items:center;gap:8px;
  }

  .btn-icon{
    width:var(--btnSize);height:var(--btnSize);
    border:2px solid var(--border);background:#fff;
    border-radius:12px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;
    font-size:16px; position:relative;
  }
  .btn-icon .icon{width:18px;height:18px}

  /* Dot indicator for icon buttons (Filter / Menu) */
  .btn-icon.has-dot::after{
    content:"";
    position:absolute;
    right:6px;
    top:6px;
    width:7px;height:7px;border-radius:999px;
    background:#111;
  }

  /* View tabs (underline active) */
  .view-tab{
    width:44px;height:44px;border:none;background:transparent;
    display:inline-flex;align-items:center;justify-content:center;
    cursor:pointer;color:#111;border-radius:12px;position:relative;
    transition:transform .12s ease, opacity .12s ease;
    opacity:.92;
  }
  .view-tab:hover{opacity:1;transform:translateY(-1px)}
  .view-tab.active::after{
    content:"";position:absolute;left:50%;transform:translateX(-50%);
    bottom:2px;width:22px;height:2px;background:#111;border-radius:999px;
  }
  .view-tab .icon{width:20px;height:20px}

  /* Actions row wrapper (to allow the “magical” drag icon) */
  .actions{display:flex;align-items:center;gap:10px;}
  .actions-right{display:flex;align-items:center;gap:10px;position:relative;}

  /* Drag-mode icon (appears only when dragMode is ON) */
  .btn-dragmode{
    position:absolute;
    left: calc(var(--btnSize) + 10px);
    top:0;
    width:var(--btnSize);height:var(--btnSize);
    border:2px solid var(--border);background:#fff;border-radius:12px;
    display:inline-flex;align-items:center;justify-content:center;
    opacity:0;
    pointer-events:none;
    transform:translateX(-8px);
    transition:opacity .16s ease, transform .16s ease;
  }
  .btn-dragmode .icon{width:18px;height:18px}

  body.drag-mode .btn-dragmode{
    opacity:1;
    pointer-events:auto;
    transform:translateX(0);
  }
  #btnMenu{transition:transform .16s ease;}
  body.drag-mode #btnMenu{transform:translateX(var(--shiftX));}

  /* Filters row (pills) */
  .filters-row{
    display:flex;gap:10px;align-items:center;justify-content:center;
    padding:2px 0 0;
    width:100%;
  }

  .dd{position:relative}
  .dd-toggle{
    border:2px solid var(--border);
    background:#f6f6f6;
    padding:var(--ui-pad-y) var(--ui-pad-x);
    min-width:var(--dd-minw);max-width:200px;
    cursor:pointer;display:inline-flex;justify-content:space-between;align-items:center;gap:8px;
    border-radius:var(--ui-radius);
    font-weight:700;font-size:var(--ui-font);
    white-space:nowrap;
    position:relative;
  }
  .dd-toggle .label-clip{overflow:hidden;text-overflow:ellipsis}
  .dd-toggle .chev{margin-left:8px;opacity:.9}

  /* Dot indicator (top-right corner of pill) */
  .dd-toggle.has-selection::after{
    content:"";
    position:absolute;
    right:10px;
    top:6px;
    width:7px;height:7px;border-radius:999px;
    background:#111;
  }

  .dd-menu{
    position:absolute;top:calc(100% + 8px);left:0;min-width:100%;background:#fff;border:1px solid var(--border);
    box-shadow:0 8px 24px rgba(0,0,0,.12);display:none;z-index:30;border-radius:12px;padding:6px
  }
  .dd.open .dd-menu{display:block}
  .dd-item{padding:8px 10px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px;border-radius:8px}
  .dd-item:hover{background:#f9fafb}
  .dd-item .radio{width:16px;height:16px;border:2px solid #ddd;border-radius:50%;position:relative;flex-shrink:0}
  .dd-item.active .radio{border-color:#111}
  .dd-item.active .radio::after{
    content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:7px;height:7px;background:#111;border-radius:50%;
  }
  .dd-item .label{flex:1}
  .dd-item .count{color:#999;font-size:12px}

  /* Menu */
  .menu{position:relative}
  .menu-panel{
    position:absolute;right:0;top:calc(100% + 8px);
    min-width:300px;background:#fff;border:1px solid var(--border);
    box-shadow:0 8px 24px rgba(0,0,0,.12);display:none;z-index:40;border-radius:12px;padding:10px
  }
  .menu.open .menu-panel{display:block}

  .menu-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;cursor:pointer}
  .menu-row:hover{background:#f9fafb}

  .menu-row-col{display:flex;flex-direction:column;gap:3px}
  .menu-row-title{font-weight:800}
  .menu-row-sub{font-weight:600;font-size:12px;color:#6b7280}

  .switch{position:relative;width:42px;height:22px;background:#ddd;cursor:pointer;border-radius:12px}
  .switch::after{
    content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;
    transition:transform .18s;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.2)
  }
  .switch.on{background:#111}
  .switch.on::after{transform:translateX(20px)}

  .menu-sep{height:1px;background:var(--border);margin:8px 0}
  .menu-h{font-weight:800;font-size:12px;color:#6b7280;padding:6px 2px}

  .menu-radio{
    display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:8px;cursor:pointer;
  }
  .menu-radio:hover{background:#f9fafb}
  .menu-radio .r{
    width:16px;height:16px;border:2px solid #ddd;border-radius:50%;position:relative;flex-shrink:0;margin-top:2px
  }
  .menu-radio.active .r{border-color:#111}
  .menu-radio.active .r::after{
    content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:7px;height:7px;background:#111;border-radius:50%;
  }
  .menu-radio .txt{font-weight:800;font-size:13px}
  .menu-radio .sub{font-weight:600;font-size:12px;color:#6b7280;margin-top:2px}

  .menu-actions{
    display:none;
    gap:8px;
    padding:8px 2px 0;
  }
  body.drag-enabled .menu-actions{display:flex}

  .btn-mini{
    border:1px solid var(--border);
    background:#fff;
    color:#111;
    padding:8px 10px;
    border-radius:999px;
    font-weight:800;
    font-size:12px;
    cursor:pointer;
  }
  .btn-mini.primary{background:#111;color:#fff;border-color:#111;}

  .menu-note{
    color:#6b7280;font-size:12px;padding:8px 0;margin-top:8px;
    border-top:1px solid var(--border);line-height:1.4;
  }

  /* Hide order section unless dragEnabled */
  .order-section{display:none}
  body.drag-enabled .order-section{display:block}

  /* Bio */
  .bio{display:none;border:1px solid var(--border);padding:14px;margin:10px 0 12px;border-radius:12px;}
  .bio.visible{display:block}
  .bio-top{display:grid;grid-template-columns:56px 1fr;gap:10px;align-items:center;margin-bottom:4px;}
  .bio-avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;background:#eee}
  .bio-username{font-weight:800;font-size:16px}
  .bio-name{font-weight:600;margin-top:3px;font-size:14px;white-space:nowrap}
  .bio-lines{white-space:pre-wrap;margin:8px 0;line-height:1.45;font-size:14px}
  .bio-link a{color:#1B4B91;text-decoration:none;font-weight:600;font-size:14px}

  /* Grid */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap);margin-top:0;}
  .card{position:relative;background:#f5f5f5;cursor:pointer;overflow:hidden;aspect-ratio:4/5;transition:opacity .2s, transform .2s, box-shadow .2s;}
  .card-img,.card-video{width:100%;height:100%;object-fit:cover;display:block;}
  .card-video{pointer-events:none}
  .card-video::-webkit-media-controls-enclosure,
  .card-video::-webkit-media-controls{display:none !important;}

  .badge{position:absolute;top:6px;right:6px;z-index:2;display:flex;gap:6px;align-items:center;}
  .badge-icon{width:16px;height:16px;display:block;color:#fff;filter:drop-shadow(0 1px 2px rgba(0,0,0,.65));}
  .badge-icon *{fill: currentColor;stroke: currentColor;}

  .card-overlay{
    position:absolute;bottom:0;left:0;right:0;
    background:linear-gradient(to top, rgba(0,0,0,.55) 0%, transparent 100%);
    padding:8px;display:flex;justify-content:space-between;align-items:flex-end;
    color:#fff;opacity:0;transition: opacity .18s ease;
  }
  .card:hover .card-overlay{opacity:1}
  .card-title{font-weight:600;font-size:12px;text-shadow:0 1px 2px rgba(0,0,0,0.5);}
  .card-title:empty{display:none;}
  .card-date{font-size:11px;text-shadow:0 1px 2px rgba(0,0,0,0.5);}
  .card-placeholder{display:flex;align-items:center;justify-content:center;color:#aaa;font-size:14px;font-weight:500;}

  /* Skeleton */
  .card.skel{background:#f3f4f6;cursor:default}
  .card.skel::before{
    content:"";position:absolute;inset:0;
    background:linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 50%, #f3f4f6 100%);
    animation:pulse 1.4s ease-in-out infinite;
  }
  @keyframes pulse{0%{transform:translateX(-20%);}50%{transform:translateX(0);}100%{transform:translateX(20%);} }

  /* Drag mode visuals */
  body.drag-mode .card{cursor:grab}
  body.drag-mode .card.dragging{cursor:grabbing;transform:scale(1.03);box-shadow:0 14px 40px rgba(0,0,0,.25);z-index:5;}
  body.drag-mode .card.drag-over{outline:2px solid #111;outline-offset:-2px;}

  .card .drag-handle{
    position:absolute;left:8px;top:8px;
    width:26px;height:26px;display:none;
    align-items:center;justify-content:center;
    border-radius:10px;
    background:rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    z-index:3;
    cursor:grab;
    user-select:none;
  }
  .card .drag-handle:active{cursor:grabbing;}
  .card .drag-handle svg{width:16px;height:16px;display:block;}
  .card .drag-handle svg path{fill:#fff;}
  body.drag-mode .card .drag-handle{display:flex;}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:50;padding:20px;}
  .modal.open{display:flex}
  .modal-close{
    position:absolute;top:20px;right:20px;width:40px;height:40px;
    background:rgba(255,255,255,.9);border:none;border-radius:50%;cursor:pointer;
    font-size:24px;font-weight:bold;display:flex;align-items:center;justify-content:center;color:#111;
  }
  .modal-content{max-width:90vw;max-height:90vh;display:flex;flex-direction:column;align-items:center;gap:12px;}
  .media-wrap{position:relative;max-width:90vw;max-height:80vh;display:flex;align-items:center;justify-content:center;}
  .modal-media{max-width:90vw;max-height:80vh;object-fit:contain;box-shadow:0 8px 32px rgba(0,0,0,.4);}
  .modal-caption{color:#fff;font-size:14px;line-height:1.5;max-width:600px;text-align:center;padding:0 20px;}

  .nav-btn{
    position:absolute;top:50%;transform:translateY(-50%);
    width:40px;height:40px;border:none;border-radius:999px;
    background:rgba(255,255,255,.85);display:flex;align-items:center;justify-content:center;
    cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.25);opacity:.85;transition:opacity .15s;
  }
  .nav-btn:hover{opacity:1}
  .nav-btn.prev{left:8px}
  .nav-btn.next{right:8px}
  .nav-btn[disabled]{visibility:hidden}
  .zone{position:absolute;top:0;bottom:0;width:30%;pointer-events:auto;background:transparent}
  .zone.prev{left:0}
  .zone.next{right:0}

  .modal-pager{
    display:flex;align-items:center;justify-content:center;gap:10px;
    margin-top:8px;padding:6px 14px;border-radius:999px;background:rgba(0,0,0,.55);
  }
  .modal-counter{color:#fff;font-size:12px;opacity:.85;}
  .modal-dots{display:flex;gap:6px;justify-content:center;}
  .modal-dot{
    width:7px;height:7px;border-radius:999px;background:rgba(255,255,255,.35);
    cursor:pointer;transition:transform .15s ease, background .15s ease, opacity .15s ease, width .15s ease;
    opacity:.7;
  }
  .modal-dot.active{width:16px;background:#fff;opacity:1;transform:translateY(-1px);}

  /* Load more / less */
  .pager-row{display:flex;justify-content:center;gap:8px;margin:10px 0 0;}
  .pager-row .btn{font-size:12px;padding:6px 10px;border-radius:999px;}

  /* Tooltip */
  .tip{
    position:fixed;z-index:9999;display:none;pointer-events:none;
    background:#fff;border:1px solid #e6e7eb;box-shadow:0 10px 30px rgba(0,0,0,.10);
    border-radius:10px;padding:8px 10px;font-size:12px;color:#111;line-height:1.2;max-width:220px;
  }
  .tip.show{display:block}
  .tip .t{font-weight:600}
  .tip .s{margin-top:3px;color:#6b7280;font-weight:500}

  @media (hover:hover){
    .nav-btn{opacity:0}
    .media-wrap:hover .nav-btn{opacity:.95}
  }
  @media (max-width:640px){
    :root{ --ui-font:12px; --ui-pad-y:7px; --ui-pad-x:10px; --ui-radius:12px; }
    .wrap{padding:12px}
    .bio-top{grid-template-columns:52px 1fr}
    .bio-avatar{width:52px;height:52px}
    .nav-btn{opacity:1}
  }

  /* Readonly */
  .ro .menu { display:none; }
</style>
</head>

<body>
<main class="wrap">
  <div class="toolbar">
    <!-- ROW 1: actions -->
    <div class="toolbar-row">
      <div class="actions">
        <button id="btnRefresh" class="btn" data-tip="Refresh" data-sub="Update content">
          <animated-icons id="aiRefresh"
            src="https://animatedicons.co/get-icon?name=Restart&style=minimalistic&token=13c130bf-0940-48c2-92e3-16b6ffe3b232"
            trigger="click"
            attributes='{"variationThumbColour":"#FFFFFF","variationName":"Normal","variationNumber":1,"numberOfGroups":1,"backgroundIsGroup":false,"strokeWidth":1.48,"defaultColours":{"group-1":"#FFFFFFFF","background":"#FFFFFF"}}'
            height="18" width="18"></animated-icons>
          Refresh
        </button>

        <div class="actions-right">
          <!-- Filter icon -->
          <button id="btnFilter" class="btn-icon" data-tip="Filter" data-sub="Platforms & status" aria-label="Filter">
            <svg class="icon" viewBox="0 0 214 325" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M52.2841 61.6897H161.716C168.434 61.6897 173.875 70.0027 173.875 76.736C173.875 85.049 168.434 91.7823 161.716 91.7823H52.2841C45.5662 91.7823 40.125 83.4693 40.125 76.736C40.125 68.423 45.5662 61.6897 52.2841 61.6897Z"/>
              <path d="M52.2841 129.398H161.716C168.434 129.398 173.875 137.711 173.875 144.444C173.875 152.758 168.434 159.491 161.716 159.491H52.2841C45.5662 159.491 40.125 151.178 40.125 144.444C40.125 136.131 45.5662 129.398 52.2841 129.398Z"/>
              <path d="M52.2841 197.106H161.716C168.434 197.106 173.875 205.419 173.875 212.153C173.875 220.466 168.434 227.199 161.716 227.199H52.2841C45.5662 227.199 40.125 218.886 40.125 212.153C40.125 203.84 45.5662 197.106 52.2841 197.106Z"/>
            </svg>
          </button>

          <!-- Drag-mode icon (only visible when actively reordering) -->
          <button id="btnDragMode" class="btn-dragmode" data-tip="Drag mode" data-sub="Reorder posts" aria-label="Drag mode">
            <!-- YOU icon -->
            <svg class="icon" viewBox="0 0 512 414" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M428 47.35C439.86 54.05 452.22 61.62 463.71 69.22C452.22 76.82 439.86 84.39 428 91.09C428 89.76 427.91 88.43 427.87 87.09L427.34 69.21L427.87 51.33C427.87 49.99 427.95 48.66 428 47.33" />
              <path d="M415.6 0C404.18 0 391.96 10.53 391.16 24.23C390.547 32.8967 390.123 41.5633 389.89 50.23H323C308.55 50.1823 294.33 53.8431 281.699 60.8623C269.068 67.8814 258.45 78.0241 250.86 90.32L118.65 302.85C114.455 309.645 108.586 315.249 101.605 319.127C94.6245 323.005 86.7655 325.027 78.78 325H19C13.9609 325 9.12816 327.002 5.56497 330.565C2.00178 334.128 0 338.961 0 344C0 349.039 2.00178 353.872 5.56497 357.435C9.12816 360.998 13.9609 363 19 363H78.78C93.2299 363.048 107.45 359.387 120.081 352.368C132.712 345.349 143.33 335.206 150.92 322.91L283.08 110.37C287.28 103.568 293.157 97.9591 300.147 94.0806C307.137 90.202 315.006 88.184 323 88.22H390C390.253 96.8867 390.677 105.553 391.27 114.22C392.07 127.92 404.27 138.45 415.72 138.45C418.556 138.485 421.354 137.797 423.85 136.45C451.152 122.62 477.361 106.731 502.25 88.92C505.306 86.6403 507.788 83.6786 509.497 80.2706C511.207 76.8627 512.097 73.1027 512.097 69.29C512.097 65.4773 511.207 61.7173 509.497 58.3094C507.788 54.9014 505.306 51.9397 502.25 49.66C477.364 31.8454 451.154 15.9559 423.85 2.13C421.351 0.782161 418.549 0.0938124 415.71 0.130001L415.6 0Z" />
              <path d="M428 322.13C439.86 328.83 452.22 336.4 463.71 344C452.22 351.6 439.86 359.17 428 365.87C428 364.55 427.91 363.22 427.87 361.87L427.34 343.99L427.87 326.11C427.87 324.78 427.95 323.45 428 322.11M245.61 242.61L223.24 278.61L250.81 322.95C258.409 335.246 269.038 345.385 281.678 352.398C294.317 359.41 308.545 363.061 323 363H390C390.253 371.667 390.677 380.333 391.27 389C392.07 402.7 404.27 413.23 415.71 413.23C418.549 413.266 421.351 412.578 423.85 411.23C451.126 397.371 477.306 381.452 502.16 363.61C505.216 361.33 507.698 358.369 509.407 354.961C511.117 351.553 512.007 347.793 512.007 343.98C512.007 340.167 511.117 336.407 509.407 332.999C507.698 329.592 505.216 326.63 502.16 324.35C477.271 306.539 451.062 290.65 423.76 276.82C421.259 275.477 418.459 274.789 415.62 274.82C404.2 274.82 391.98 285.35 391.18 299.05C390.567 307.717 390.143 316.383 389.91 325.05H323C315.014 325.078 307.156 323.055 300.175 319.177C293.194 315.299 287.325 309.695 283.13 302.9L245.61 242.61Z" />
              <path d="M19 88.2199H78.78C86.7655 88.1925 94.6245 90.2146 101.605 94.0927C108.586 97.9709 114.455 103.575 118.65 110.37L156.12 170.61L178.49 134.61L150.92 90.3099C143.33 78.014 132.712 67.8714 120.081 60.8522C107.45 53.8331 93.2299 50.1722 78.78 50.2199H19C13.9609 50.2199 9.12816 52.2217 5.56497 55.7849C2.00178 59.3481 0 64.1808 0 69.2199C0 74.2591 2.00178 79.0918 5.56497 82.655C9.12816 86.2182 13.9609 88.2199 19 88.2199Z" />
            </svg>
          </button>

          <div class="menu" id="menu">
            <!-- Menu icon (3 dots) -->
            <button id="btnMenu" class="btn-icon" data-tip="Options" data-sub="Bio & order" aria-label="Options">
              <svg class="icon" viewBox="0 0 90 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M11.875 23.75C18.4334 23.75 23.75 18.4334 23.75 11.875C23.75 5.31662 18.4334 0 11.875 0C5.31662 0 0 5.31662 0 11.875C0 18.4334 5.31662 23.75 11.875 23.75Z"/>
                <path d="M78.125 23.75C84.6834 23.75 90 18.4334 90 11.875C90 5.31662 84.6834 0 78.125 0C71.5666 0 66.25 5.31662 66.25 11.875C66.25 18.4334 71.5666 23.75 78.125 23.75Z"/>
                <path d="M45 23.75C51.5584 23.75 56.875 18.4334 56.875 11.875C56.875 5.31662 51.5584 0 45 0C38.4416 0 33.125 5.31662 33.125 11.875C33.125 18.4334 38.4416 23.75 45 23.75Z"/>
              </svg>
            </button>

            <div class="menu-panel" id="menuPanel">
              <!-- Bio toggle -->
              <div class="menu-row" id="rowBio">
                <div class="menu-row-col">
                  <div class="menu-row-title">Show Bio</div>
                  <div class="menu-row-sub">Profile & link above the grid</div>
                </div>
                <div id="switchBio" class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
              </div>

              <!-- Drag toggle -->
              <div class="menu-row" id="rowDrag">
                <div class="menu-row-col">
                  <div class="menu-row-title">Drag & Drop</div>
                  <div class="menu-row-sub">Enable reorder controls</div>
                </div>
                <div id="switchDrag" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
              </div>

              <div class="order-section">
                <div class="menu-sep"></div>
                <div class="menu-h">ORDER MODE</div>

                <div id="optDate" class="menu-radio">
                  <div class="r"></div>
                  <div>
                    <div class="txt">Order by date</div>
                    <div class="sub">Sorted by publish date</div>
                  </div>
                </div>

                <div id="optCustom" class="menu-radio">
                  <div class="r"></div>
                  <div>
                    <div class="txt">Custom order</div>
                    <div class="sub">Use your saved order</div>
                  </div>
                </div>

                <div class="menu-actions" id="menuActions">
                  <button id="btnCancelOrder" class="btn-mini">Cancel</button>
                  <button id="btnSaveOrder" class="btn-mini primary">Save</button>
                </div>

                <div class="menu-note">
                  Custom order is saved in the widget (not in Notion).
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- ROW 2: filter pills -->
    <div id="filtersRow" class="filters-row" aria-label="Filters">
      <div class="dd" id="ddPlatforms">
        <button class="dd-toggle" id="togglePlatforms">
          <span class="label-clip" id="labelPlatforms">All Platforms</span>
          <span class="chev">▾</span>
        </button>
        <div class="dd-menu" id="menuPlatforms"></div>
      </div>

      <div class="dd" id="ddStatus">
        <button class="dd-toggle" id="toggleStatus">
          <span class="label-clip" id="labelStatus">All Status</span>
          <span class="chev">▾</span>
        </button>
        <div class="dd-menu" id="menuStatus"></div>
      </div>
    </div>

    <!-- ROW 3: tabs -->
    <div class="toolbar-row views">
      <button id="btnViewGrid" class="view-tab active" data-tip="Grid" data-sub="Published content grid" aria-label="Grid view">
        <svg class="icon" viewBox="0 0 232 238" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M197.075 0H34.7727C15.5826 0.0222236 0.0222545 15.9334 0 35.5556V201.512C0.0217343 221.134 15.5826 237.045 34.7727 237.067H197.075C216.265 237.045 231.826 221.134 231.848 201.512V35.5556C231.826 15.9334 216.265 0.0227556 197.075 0ZM92.7347 142.234V94.8338H139.113V142.245L92.7347 142.234ZM139.113 165.934V213.356H92.7347V165.945L139.113 165.934ZM23.1892 94.8338H69.5455V142.245L23.1892 142.234V94.8338ZM92.7347 71.1339V23.7113H139.113L139.102 71.1225L92.7347 71.1339ZM162.291 94.8338H208.659V142.245H162.291V94.8338ZM208.659 35.5669L208.648 71.1225H162.28L162.291 23.7113H197.064C203.464 23.7113 208.659 29.0113 208.659 35.5558V35.5669ZM34.7727 23.7113H69.5455V71.1225H23.1892V35.5556C23.1892 29.0111 28.3723 23.7113 34.7727 23.7113ZM23.189 201.512V165.945H69.5452V213.367L34.7724 213.356C28.372 213.356 23.189 208.056 23.189 201.512ZM197.075 213.367H162.302V165.945H208.669V201.512H208.659C208.659 208.056 203.475 213.356 197.075 213.356L197.075 213.367Z"/>
        </svg>
      </button>

      <button id="btnViewReels" class="view-tab" data-tip="Reels" data-sub="Videos only" aria-label="Reels view">
        <svg class="icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M502.08 127.37C492 70.4601 441.54 20.0001 384.63 9.92006H384.44C344.75 3.28007 302.74 0.0500649 256 6.48682e-05C209.26 -0.0499351 167.24 3.29007 127.56 9.89007H127.37C70.47 20.0001 20 70.4701 9.93 127.37C9.92431 127.433 9.92431 127.497 9.93 127.56C3.3 167.24 0.0599961 209.24 -3.85515e-06 256C-0.0600039 302.76 3.3 344.79 9.89 384.45C9.88533 384.51 9.88533 384.57 9.89 384.63C20 441.53 70.47 492 127.37 502.08H127.56C167.26 508.68 209.27 511.92 256.03 511.97C302.79 512.02 344.75 508.68 384.45 502.08H384.64C441.54 492 492 441.53 502.08 384.63V384.44C508.71 344.77 512 302.76 512 256C512 209.24 508.71 167.26 502.11 127.58L502.08 127.37ZM464.64 378.11C457.32 419.33 419.34 457.31 378.12 464.64C340.52 470.89 300.57 474 256 474C211.43 474 171.47 470.89 133.87 464.64C92.65 457.31 54.67 419.33 47.34 378.1C41.12 340.55 38.06 300.6 38 256C37.8795 222.467 39.9237 188.96 44.12 155.69C136.6 146.24 193.37 143.66 255.64 143.6C332.53 143.67 402.12 147.6 467.87 155.75C472.07 189 474.118 222.486 474 256C474 300.58 470.89 340.53 464.64 378.11Z"/>
          <path d="M342.41 285.08C328.41 276.69 314.15 267.33 300.33 258.28C294.83 254.69 289.38 251.11 283.98 247.63C267.79 237.15 246.66 223.9 226.69 214.24C216.57 209.3 204.4 209.91 193.29 215.92C178.99 223.65 168.52 238.59 166.62 253.99V254.31C165.09 268.73 164.04 283.21 163.51 297.31C163.51 298.04 163.24 309.21 163.24 319.57C163.24 329.93 163.5 341.11 163.51 341.57C164.04 355.94 165.09 370.42 166.62 384.83V385.15C168.52 400.55 178.99 415.49 193.29 423.22C199.056 426.429 205.532 428.147 212.13 428.22C217.165 428.269 222.145 427.168 226.69 425C246.69 415.34 267.8 402.09 283.97 391.63C289.377 388.13 294.83 384.573 300.33 380.96C314.15 371.91 328.45 362.56 342.41 354.16C355.21 346.44 362.81 333.55 362.81 319.67C362.81 305.79 355.21 292.83 342.41 285.08Z"/>
        </svg>
      </button>

      <button id="btnViewDrafts" class="view-tab" data-tip="Drafts" data-sub="Status = Draft" aria-label="Drafts view">
        <svg class="icon" viewBox="0 0 69 69" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0.000900269 16.664C0.000900269 7.4609 7.4697 0 16.6809 0H52.1969C61.4078 0 68.8769 7.4609 68.8769 16.664C68.8769 18.0468 67.7597 19.1718 66.3691 19.1718H2.5101C1.1273 19.1718 0.00230026 18.0468 0.00230026 16.664H0.000900269ZM64.7119 29.586C67.0088 29.586 68.876 31.4532 68.876 33.7579V52.2029C68.876 61.406 61.4072 68.8669 52.196 68.8669H16.68C7.4691 68.8669 0 61.406 0 52.2029V33.7579C0 31.4532 1.8672 29.586 4.1719 29.586H15.7269C18.0238 29.586 19.805 31.5626 20.9066 33.5782C22.3285 36.1563 25.0707 37.9063 28.2269 37.9063H40.6649C43.8133 37.9063 46.5633 36.1563 47.9774 33.5782C49.0868 31.5626 50.8602 29.586 53.1649 29.586H64.7119Z"/>
        </svg>
      </button>
    </div>
  </div>

  <section id="bio" class="bio visible" aria-hidden="false">
    <div class="bio-top">
      <img id="bioAvatar" class="bio-avatar" alt="" style="display:none" />
      <div>
        <div id="bioUsername" class="bio-username"></div>
        <div id="bioName" class="bio-name"></div>
      </div>
    </div>
    <div id="bioLines" class="bio-lines"></div>
    <div class="bio-link"><a id="bioUrl" href="#" target="_blank" rel="noopener"></a></div>
  </section>

  <section id="grid" class="grid" aria-live="polite"></section>

  <div class="pager-row" id="pagerRow">
    <button id="btnLess" class="btn" style="display:none;">Show less</button>
    <button id="btnMore" class="btn" style="display:none;">Load more</button>
  </div>
</main>

<div id="modal" class="modal" aria-hidden="true">
  <button class="modal-close" id="modalClose">×</button>
  <div class="modal-content">
    <div id="mediaWrap" class="media-wrap">
      <div id="modalMedia"></div>
      <button id="btnPrev" class="nav-btn prev" aria-label="Previous">‹</button>
      <button id="btnNext" class="nav-btn next" aria-label="Next">›</button>
      <div id="zonePrev" class="zone prev" aria-hidden="true"></div>
      <div id="zoneNext" class="zone next" aria-hidden="true"></div>
    </div>

    <div id="modalPager" class="modal-pager">
      <div id="modalDots" class="modal-dots"></div>
      <div id="modalCounter" class="modal-counter"></div>
    </div>

    <div id="modalCaption" class="modal-caption"></div>
  </div>
</div>

<div id="tip" class="tip" role="tooltip" aria-hidden="true">
  <div class="t" id="tipT"></div>
  <div class="s" id="tipS"></div>
</div>

<script>
  const READONLY = new URLSearchParams(window.location.search).get("readonly") === "1";
  if (READONLY) document.body.classList.add("ro");

  const BASE_LIMIT = 12;

  const state = {
    dbId: null,
    items: [],
    selectedPlatform: null,
    selectedStatus: null,
    bio: null,
    showBio: true,

    viewMode: "grid",     // grid | reels | drafts
    dragEnabled: false,   // toggle in menu
    orderMode: "date",    // date | custom (only meaningful when dragEnabled)
    dragMode: false,      // true ONLY while actively reordering

    modalAssets: [],
    modalIndex: 0,
    modalCaption: "",
    visibleCount: BASE_LIMIT
  };

  // ===== DOM refs =====
  const $grid = document.getElementById("grid");
  const $btnRefresh = document.getElementById("btnRefresh");
  const $btnFilter = document.getElementById("btnFilter");
  const $btnDragMode = document.getElementById("btnDragMode");

  const $ddPlatforms = document.getElementById("ddPlatforms");
  const $togglePlatforms = document.getElementById("togglePlatforms");
  const $menuPlatforms = document.getElementById("menuPlatforms");
  const $labelPlatforms = document.getElementById("labelPlatforms");

  const $ddStatus = document.getElementById("ddStatus");
  const $toggleStatus = document.getElementById("toggleStatus");
  const $menuStatus = document.getElementById("menuStatus");
  const $labelStatus = document.getElementById("labelStatus");

  const $menu = document.getElementById("menu");
  const $btnMenu = document.getElementById("btnMenu");
  const $menuPanel = document.getElementById("menuPanel");

  const $rowBio = document.getElementById("rowBio");
  const $switchBio = document.getElementById("switchBio");

  const $rowDrag = document.getElementById("rowDrag");
  const $switchDrag = document.getElementById("switchDrag");

  const $optDate = document.getElementById("optDate");
  const $optCustom = document.getElementById("optCustom");
  const $btnCancelOrder = document.getElementById("btnCancelOrder");
  const $btnSaveOrder = document.getElementById("btnSaveOrder");

  const $bio = document.getElementById("bio");
  const $bioUsername = document.getElementById("bioUsername");
  const $bioName = document.getElementById("bioName");
  const $bioLines = document.getElementById("bioLines");
  const $bioUrl = document.getElementById("bioUrl");
  const $bioAvatar = document.getElementById("bioAvatar");

  const $modal = document.getElementById("modal");
  const $mediaWrap = document.getElementById("mediaWrap");
  const $modalMedia = document.getElementById("modalMedia");
  const $modalPager = document.getElementById("modalPager");
  const $modalDots = document.getElementById("modalDots");
  const $modalCounter = document.getElementById("modalCounter");
  const $modalCaption = document.getElementById("modalCaption");
  const $modalClose = document.getElementById("modalClose");
  const $btnPrev = document.getElementById("btnPrev");
  const $btnNext = document.getElementById("btnNext");
  const $zonePrev = document.getElementById("zonePrev");
  const $zoneNext = document.getElementById("zoneNext");

  const $aiRefresh = document.getElementById("aiRefresh");

  const $btnViewGrid = document.getElementById("btnViewGrid");
  const $btnViewReels = document.getElementById("btnViewReels");
  const $btnViewDrafts = document.getElementById("btnViewDrafts");

  const $btnMore = document.getElementById("btnMore");
  const $btnLess = document.getElementById("btnLess");

  /* Tooltip wiring */
  const $tip = document.getElementById("tip");
  const $tipT = document.getElementById("tipT");
  const $tipS = document.getElementById("tipS");

  function showTip(el){
    const t = el.getAttribute("data-tip");
    if (!t) return;
    const s = el.getAttribute("data-sub") || "";
    $tipT.textContent = t;
    $tipS.textContent = s;
    $tip.classList.add("show");
    $tip.setAttribute("aria-hidden","false");
  }
  function moveTip(e){
    const pad = 12;
    $tip.style.left = ((e.clientX ?? 0) + pad) + "px";
    $tip.style.top  = ((e.clientY ?? 0) + pad) + "px";
  }
  function hideTip(){
    $tip.classList.remove("show");
    $tip.setAttribute("aria-hidden","true");
  }
  function bindTip(el){
    el.addEventListener("mouseenter", () => showTip(el));
    el.addEventListener("mousemove", moveTip);
    el.addEventListener("mouseleave", hideTip);
  }
  [$btnRefresh,$btnFilter,$btnMenu,$btnDragMode,$btnViewGrid,$btnViewReels,$btnViewDrafts].forEach(b => b && bindTip(b));

  function formatDate(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d)) return "";
    return d.toLocaleDateString("en-US",{month:"short",day:"numeric"});
  }

  function setSwitch(el,on){
    el.classList.toggle("on", !!on);
    el.setAttribute("aria-checked", !!on);
  }

  function applyBodyModes(){
    document.body.classList.toggle("drag-enabled", !!state.dragEnabled);
    document.body.classList.toggle("drag-mode", !!state.dragMode);
  }

  function updateOrderMenuUI(){
    $optDate.classList.toggle("active", state.orderMode === "date");
    $optCustom.classList.toggle("active", state.orderMode === "custom");
  }

  // ===== Panel manager: only one open at a time =====
  function openPanel(which){
    // close all
    $ddPlatforms.classList.remove("open");
    $ddStatus.classList.remove("open");
    $menu.classList.remove("open");

    if (which === "platforms") $ddPlatforms.classList.add("open");
    if (which === "status") $ddStatus.classList.add("open");
    if (which === "menu") $menu.classList.add("open");
  }

  // stopPropagation inside panels (prevents “open by default” feeling + weird toggles)
  $menuPlatforms.addEventListener("click", e => e.stopPropagation());
  $menuStatus.addEventListener("click", e => e.stopPropagation());
  $menuPanel.addEventListener("click", e => e.stopPropagation());

  // ===== Dots =====
  function setPillDots(){
    $togglePlatforms.classList.toggle("has-selection", !!state.selectedPlatform);
    $toggleStatus.classList.toggle("has-selection", !!state.selectedStatus);

    // Filter icon dot if ANY filter active
    const hasFilter = !!state.selectedPlatform || !!state.selectedStatus;
    $btnFilter.classList.toggle("has-dot", hasFilter);

    // Menu dot if ANY setting “non-default”
    const menuDirty = (!state.showBio) || (state.dragEnabled && state.orderMode === "custom");
    $btnMenu.classList.toggle("has-dot", menuDirty);
  }

  // ===== Persist order in localStorage (per db) =====
  function getOrderKey(){
    if (!state.dbId) return null;
    return `igGridOrder:${state.dbId}`;
  }
  function loadSavedOrder(){
    const key = getOrderKey();
    if (!key) return;
    let raw;
    try{ raw = localStorage.getItem(key); }catch(e){ return; }
    if (!raw) return;

    let ids;
    try{ ids = JSON.parse(raw); }catch(e){ return; }
    if (!Array.isArray(ids) || !ids.length) return;

    const indexById = new Map();
    ids.forEach((id, idx) => indexById.set(id, idx));
    (state.items || []).forEach(it => {
      const id = it._id || it.id;
      if (!id) return;
      if (indexById.has(id)) it._order = indexById.get(id);
    });
  }
  function saveCurrentOrder(){
    if (READONLY) return;
    const key = getOrderKey();
    if (!key) return;
    const ids = (state.items || []).map(it => it._id || it.id).filter(Boolean);
    if (!ids.length) return;
    try{ localStorage.setItem(key, JSON.stringify(ids)); }catch(e){}
  }

  let snapshotBeforeDrag = null;
  function takeSnapshot(){
    snapshotBeforeDrag = (state.items || []).map(it => ({ id: it._id, order: it._order }));
  }
  function restoreSnapshot(){
    if (!snapshotBeforeDrag) return;
    const map = new Map(snapshotBeforeDrag.map(x => [x.id, x.order]));
    (state.items || []).forEach(it => {
      if (map.has(it._id)) it._order = map.get(it._id);
    });
    snapshotBeforeDrag = null;
  }
  function applyOrderNumbers(arr){
    arr.forEach((it, i) => { it._order = i; });
  }

  function resortItems(){
    state.items = (state.items || []).slice().sort((a,b) => {
      if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;

      // Date mode always sorts by publishDate if drag is disabled or orderMode=date
      const dateMode = (!state.dragEnabled) || (state.orderMode === "date");
      if (dateMode){
        const da = a.publishDate ? new Date(a.publishDate).getTime() : 0;
        const db = b.publishDate ? new Date(b.publishDate).getTime() : 0;
        if (db !== da) return db - da;
      }

      const oa = typeof a._order === "number" ? a._order : 0;
      const ob = typeof b._order === "number" ? b._order : 0;
      return oa - ob;
    });
  }

  function reorderByIds(sourceId, targetId){
    if (!sourceId || !targetId || sourceId === targetId) return;
    const arr = (state.items || []).slice();
    const fromIndex = arr.findIndex(x => x._id === sourceId);
    const toIndex = arr.findIndex(x => x._id === targetId);
    if (fromIndex === -1 || toIndex === -1) return;

    const [moved] = arr.splice(fromIndex,1);
    arr.splice(toIndex,0,moved);
    applyOrderNumbers(arr);
    state.items = arr;
    renderGrid();
  }

  function escAttr(s){
    return (s || "").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function renderSkeleton(){
    $grid.innerHTML = Array.from({length:9}).map(() => '<div class="card skel"></div>').join("");
  }

  function passPlatform(it){ return !state.selectedPlatform || it.platform === state.selectedPlatform; }
  function passStatus(it){ return !state.selectedStatus || it.status === state.selectedStatus; }
  function isDraft(it){
    if (!it || !it.status) return false;
    return it.status === "Draft" || it.status === "Borrador";
  }
  function passViewMode(it){
    if (READONLY && isDraft(it)) return false;
    if (state.viewMode === "reels") return !!it.isVideo && !isDraft(it);
    if (state.viewMode === "drafts") return isDraft(it);
    return !isDraft(it);
  }
  function passFilters(it){
    return passPlatform(it) && passStatus(it) && passViewMode(it);
  }

  function renderBio(){
    const b = state.bio;
    if (!b || !state.showBio){
      $bio.classList.remove("visible");
      $bio.setAttribute("aria-hidden","true");
      return;
    }
    $bioUsername.textContent = b.username || "";
    $bioName.textContent = b.name || "";
    $bioLines.textContent = (b.textLines || []).join("\n");
    const cleanUrl = (b.url || "").replace(/^https?:\/\//,"");
    $bioUrl.textContent = cleanUrl || "";
    $bioUrl.href = b.url || "#";

    if (b.avatar){
      $bioAvatar.src = b.avatar;
      $bioAvatar.style.display = "block";
    } else {
      $bioAvatar.style.display = "none";
    }
    $bio.classList.add("visible");
    $bio.setAttribute("aria-hidden","false");
  }

  function toggleBio(){
    state.showBio = !state.showBio;
    try{ localStorage.setItem("showBio", String(state.showBio)); }catch(e){}
    setSwitch($switchBio, state.showBio);
    renderBio();
    setPillDots();
  }

  function setDragEnabled(on){
    if (READONLY) return;
    state.dragEnabled = !!on;

    // If turned OFF: force date mode and exit drag mode
    if (!state.dragEnabled){
      state.orderMode = "date";
      state.dragMode = false;
      snapshotBeforeDrag = null;
    }

    try{ localStorage.setItem("dragEnabled", String(state.dragEnabled)); }catch(e){}
    try{ localStorage.setItem("orderMode", state.orderMode); }catch(e){}

    setSwitch($switchDrag, state.dragEnabled);
    updateOrderMenuUI();
    applyBodyModes();
    renderGrid();
    setPillDots();
  }

  function setOrderMode(mode){
    if (READONLY) return;
    if (!state.dragEnabled) return; // order mode only when enabled
    if (mode !== "date" && mode !== "custom") return;

    state.orderMode = mode;
    try{ localStorage.setItem("orderMode", mode); }catch(e){}

    // switching to date exits dragMode
    if (mode === "date"){
      state.dragMode = false;
      snapshotBeforeDrag = null;
    }

    // switching to custom starts dragMode
    if (mode === "custom"){
      startDragMode();
    }

    updateOrderMenuUI();
    applyBodyModes();
    renderGrid();
    setPillDots();
  }

  function startDragMode(){
    if (READONLY) return;
    if (!state.dragEnabled) return;
    state.orderMode = "custom";
    if (!state.dragMode){
      takeSnapshot();
      state.dragMode = true;
    }
    updateOrderMenuUI();
    applyBodyModes();
    renderGrid();
    setPillDots();
  }

  function cancelDragMode(){
    if (READONLY) return;
    restoreSnapshot();
    state.dragMode = false; // stay in custom mode but not actively dragging
    applyBodyModes();
    renderGrid();
  }

  function saveDragMode(){
    if (READONLY) return;
    saveCurrentOrder();
    state.dragMode = false;
    snapshotBeforeDrag = null;
    applyBodyModes();
    renderGrid();
  }

  function renderMenus(){
    const items = state.items || [];
    const platCounts = {};
    const statusCounts = {};

    items.forEach(it => {
      if (it.platform) platCounts[it.platform] = (platCounts[it.platform] || 0) + 1;
      if (it.status) statusCounts[it.status] = (statusCounts[it.status] || 0) + 1;
    });

    const platforms = Object.keys(platCounts).sort((a,b) => platCounts[b]-platCounts[a]);
    const statuses  = Object.keys(statusCounts).sort((a,b) => statusCounts[b]-statusCounts[a]);

    const platMenuItems = ["All Platforms", ...platforms];
    $menuPlatforms.innerHTML = platMenuItems.map(name => {
      const active = (name === "All Platforms" && !state.selectedPlatform) || state.selectedPlatform === name;
      const count = name === "All Platforms" ? items.filter(passStatus).length : (platCounts[name] || 0);
      return `<div class="dd-item ${active?"active":""}" data-v="${name}">
        <div class="radio"></div>
        <div class="label">${name}</div>
        <div class="count">${count}</div>
      </div>`;
    }).join("");

    Array.from($menuPlatforms.children).forEach(el => {
      el.onclick = (e) => {
        e.stopPropagation();
        const val = el.getAttribute("data-v");
        state.visibleCount = BASE_LIMIT;
        state.selectedPlatform = (val === "All Platforms") ? null : val;
        $labelPlatforms.textContent = val;
        setPillDots();
        renderGrid();
        openPanel(null);
      };
    });

    const statusMenuItems = ["All Status", ...statuses];
    $menuStatus.innerHTML = statusMenuItems.map(name => {
      const active = (name === "All Status" && !state.selectedStatus) || state.selectedStatus === name;
      const count = name === "All Status" ? items.filter(passPlatform).length : (statusCounts[name] || 0);
      return `<div class="dd-item ${active?"active":""}" data-v="${name}">
        <div class="radio"></div>
        <div class="label">${name}</div>
        <div class="count">${count}</div>
      </div>`;
    }).join("");

    Array.from($menuStatus.children).forEach(el => {
      el.onclick = (e) => {
        e.stopPropagation();
        const val = el.getAttribute("data-v");
        state.visibleCount = BASE_LIMIT;
        state.selectedStatus = (val === "All Status") ? null : val;
        $labelStatus.textContent = val;
        setPillDots();
        renderGrid();
        openPanel(null);
      };
    });

    $labelPlatforms.textContent = state.selectedPlatform || "All Platforms";
    $labelStatus.textContent = state.selectedStatus || "All Status";
    setPillDots();
  }

  // ===== Badges + drag handle =====
  const ICONS = {
    pinned: `<svg class="badge-icon" viewBox="0 0 445 445" aria-hidden="true"><path fill-rule="evenodd" clip-rule="evenodd" d="M266.589 0L444.996 178.274L378.093 200.558L288.89 289.696L266.589 356.547L88.1816 178.274L155.085 155.989L244.288 66.8527L266.589 0ZM130.832 280.318L0 411.052L33.6409 444.667L164.473 313.932L130.832 280.318Z"></path></svg>`,
    reels: `<svg class="badge-icon" viewBox="0 0 512 512" aria-hidden="true"><path d="M502.08 127.37C492 70.4601 441.54 20.0001 384.63 9.92006H384.44C344.75 3.28007 302.74 0.0500649 256 6.48682e-05C209.26 -0.0499351 167.24 3.29007 127.56 9.89007H127.37C70.47 20.0001 20 70.4701 9.93 127.37C9.92431 127.433 9.92431 127.497 9.93 127.56C3.3 167.24 0.0599961 209.24 -3.85515e-06 256C-0.0600039 302.76 3.3 344.79 9.89 384.45C9.88533 384.51 9.88533 384.57 9.89 384.63C20 441.53 70.47 492 127.37 502.08H127.56C167.26 508.68 209.27 511.92 256.03 511.97C302.79 512.02 344.75 508.68 384.45 502.08H384.64C441.54 492 492 441.53 502.08 384.63V384.44C508.71 344.77 512 302.76 512 256C512 209.24 508.71 167.26 502.11 127.58L502.08 127.37Z"></path><path d="M342.41 285.08C328.41 276.69 314.15 267.33 300.33 258.28C294.83 254.69 289.38 251.11 283.98 247.63C267.79 237.15 246.66 223.9 226.69 214.24C216.57 209.3 204.4 209.91 193.29 215.92C178.99 223.65 168.52 238.59 166.62 253.99V254.31C165.09 268.73 164.04 283.21 163.51 297.31C163.51 298.04 163.24 309.21 163.24 319.57C163.24 329.93 163.5 341.11 163.51 341.57C164.04 355.94 165.09 370.42 166.62 384.83V385.15C168.52 400.55 178.99 415.49 193.29 423.22C199.056 426.429 205.532 428.147 212.13 428.22C217.165 428.269 222.145 427.168 226.69 425C246.69 415.34 267.8 402.09 283.97 391.63C289.377 388.13 294.83 384.573 300.33 380.96C314.15 371.91 328.45 362.56 342.41 354.16C355.21 346.44 362.81 333.55 362.81 319.67C362.81 305.79 355.21 292.83 342.41 285.08Z"></path></svg>`,
    carousel: `<svg class="badge-icon" viewBox="0 0 560 560" aria-hidden="true"><path fill="none" fill-rule="evenodd" clip-rule="evenodd" d="M445.632 351.936C445.632 403.683 403.683 445.632 351.936 445.632H117.696C65.9491 445.632 24 403.683 24 351.936V117.696C24 65.9491 65.9491 24 117.696 24H351.936C403.683 24 445.632 65.9491 445.632 117.696V351.936Z" stroke="currentColor" stroke-width="48" stroke-linecap="round" stroke-linejoin="round"/><path fill="none" d="M208.064 536H442.304C494.051 536 536 494.048 536 442.304V208.062" stroke="currentColor" stroke-width="48" stroke-linecap="round" stroke-linejoin="round"/></svg>`
  };

  const ICON_SVG_DRAG_HANDLE = `
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
      <path d="M9 5H11V7H9V5ZM13 5H15V7H13V5ZM9 10H11V12H9V10ZM13 10H15V12H13V10ZM9 15H11V17H9V15ZM13 15H15V17H13V15Z" />
    </svg>
  `;

  function renderGrid(){
    resortItems();

    const allFiltered = (state.items || []).filter(passFilters);
    const total = allFiltered.length;

    const emptyMsg =
      state.viewMode === "reels" ? "No reels with video yet" :
      state.viewMode === "drafts" ? "No drafts yet" :
      "No content";

    if (!total){
      $grid.innerHTML = Array.from({length:BASE_LIMIT})
        .map(() => `<div class="card card-placeholder">${emptyMsg}</div>`)
        .join("");
      $btnMore.style.display = "none";
      $btnLess.style.display = "none";
      return;
    }

    const visible = Math.min(state.visibleCount || BASE_LIMIT, total);
    const items = allFiltered.slice(0, visible);

    const realCardsHtml = items.map((it, idx) => {
      const badges = [];
      const isCarousel = Array.isArray(it.assets) && it.assets.length > 1;

      if (state.viewMode === "reels"){
        badges.push(ICONS.reels);
      } else {
        if (it.pinned) badges.push(ICONS.pinned);
        if (it.isVideo) badges.push(ICONS.reels);
        if (isCarousel) badges.push(ICONS.carousel);
      }

      const handleHtml = (!READONLY && state.dragMode)
        ? `<div class="drag-handle" title="Reorder" aria-hidden="true">${ICON_SVG_DRAG_HANDLE}</div>`
        : "";

      const first = (it.assets && it.assets[0]) || null;
      let media = "";
      if (first){
        if (first.type === "video"){
          media = `<video class="card-video" src="${first.url}" muted loop playsinline preload="metadata"></video>`;
        } else {
          media = `<img class="card-img" src="${first.url}" alt="${escAttr(it.title || "")}" loading="lazy" decoding="async" />`;
        }
      } else {
        media = '<div class="card-placeholder">No Content</div>';
      }

      const titleHtml = it.title ? `<div class="card-title">${it.title}</div>` : '<div class="card-title"></div>';

      return `<article class="card" data-type="real" data-idx="${idx}" data-id="${it._id}">
        <div class="badge">${badges.join("")}</div>
        ${handleHtml}
        ${media}
        <div class="card-overlay">
          ${titleHtml}
          <div class="card-date">${formatDate(it.publishDate)}</div>
        </div>
      </article>`;
    }).join("");

    const placeholdersNeeded = total < BASE_LIMIT ? Math.max(0, BASE_LIMIT - items.length) : 0;
    const placeholdersHtml = Array.from({length:placeholdersNeeded})
      .map(() => `<div class="card card-placeholder">${emptyMsg}</div>`)
      .join("");

    $grid.innerHTML = realCardsHtml + placeholdersHtml;

    if (total <= BASE_LIMIT){
      $btnMore.style.display = "none";
      $btnLess.style.display = "none";
    } else {
      $btnMore.style.display = (state.visibleCount >= total) ? "none" : "inline-flex";
      $btnLess.style.display = (state.visibleCount > BASE_LIMIT) ? "inline-flex" : "none";
    }

    const cards = Array.from($grid.querySelectorAll('.card[data-type="real"]'));
    cards.forEach(card => {
      const idx = parseInt(card.getAttribute("data-idx"), 10);
      const item = items[idx];
      const id = card.getAttribute("data-id");
      const vid = card.querySelector("video.card-video");

      const mediaEl = card.querySelector("img.card-img, video.card-video");
      if (mediaEl) mediaEl.draggable = false;

      if (vid){
        card.addEventListener("mouseenter", () => { vid.play().catch(()=>{}); });
        card.addEventListener("mouseleave", () => { vid.pause(); });
      }

      // Drag logic only when dragMode
      let isPointerDown = false;
      let pointerMoved = false;
      let pointerId = null;
      let startX = 0, startY = 0;
      const DRAG_THRESHOLD = 5;

      card.addEventListener("pointerdown", (e) => {
        if (READONLY) return;
        if (!state.dragMode) return;
        if (e.button !== 0 && e.pointerType === "mouse") return;

        isPointerDown = true;
        pointerMoved = false;
        pointerId = e.pointerId;
        startX = e.clientX;
        startY = e.clientY;
        card.setPointerCapture(pointerId);
        card.classList.add("dragging");
      });

      card.addEventListener("pointermove", (e) => {
        if (!isPointerDown) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        if (!pointerMoved && Math.sqrt(dx*dx + dy*dy) > DRAG_THRESHOLD){
          pointerMoved = true;
        }

        const el = document.elementFromPoint(e.clientX, e.clientY);
        const target = el && el.closest('.card[data-type="real"]');
        cards.forEach(c => c.classList.remove("drag-over"));
        if (target && target !== card) target.classList.add("drag-over");
      });

      function endPointer(e){
        if (!isPointerDown) return;
        isPointerDown = false;
        cards.forEach(c => c.classList.remove("drag-over"));
        card.classList.remove("dragging");
        try{ if (pointerId != null) card.releasePointerCapture(pointerId); }catch(_){}
        pointerId = null;

        if (!pointerMoved) return;
        const el = document.elementFromPoint(e.clientX, e.clientY);
        const targetCard = el && el.closest('.card[data-type="real"]');
        const targetId = targetCard && targetCard.getAttribute("data-id");
        reorderByIds(id, targetId);
      }

      card.addEventListener("pointerup", endPointer);
      card.addEventListener("pointercancel", endPointer);

      // Click opens modal ONLY if not in dragMode
      if (!state.dragMode){
        card.onclick = () => openModal(item);
      } else {
        card.onclick = null;
      }
    });
  }

  // ===== Modal =====
  function renderModalDotsAndCounter(){
    const total = state.modalAssets.length;
    $modalDots.innerHTML = "";
    $modalCounter.textContent = "";

    if (!total || total === 1){
      $modalPager.style.display = "none";
      return;
    }
    $modalPager.style.display = "flex";

    const frag = document.createDocumentFragment();
    state.modalAssets.forEach((_, i) => {
      const dot = document.createElement("div");
      dot.className = "modal-dot" + (i === state.modalIndex ? " active" : "");
      dot.addEventListener("click", () => { state.modalIndex = i; renderModalAsset(); });
      frag.appendChild(dot);
    });
    $modalDots.appendChild(frag);
    $modalCounter.textContent = `${state.modalIndex + 1}/${total}`;
  }

  function renderModalAsset(){
    const idx = state.modalIndex;
    const a = state.modalAssets[idx];
    $modalMedia.innerHTML = "";
    if (!a) {
      $modalCaption.textContent = "";
      $btnPrev.disabled = true;
      $btnNext.disabled = true;
      $modalDots.innerHTML = "";
      $modalCounter.textContent = "";
      $modalPager.style.display = "none";
      return;
    }

    if (a.type === "video"){
      const v = document.createElement("video");
      v.src = a.url;
      v.autoplay = true;
      v.muted = true;
      v.playsInline = true;
      v.loop = true;
      v.className = "modal-media";
      $modalMedia.appendChild(v);
    } else {
      const i = document.createElement("img");
      i.src = a.url;
      i.alt = "";
      i.className = "modal-media";
      $modalMedia.appendChild(i);
    }

    $modalCaption.textContent = idx === 0 ? state.modalCaption : "";
    $btnPrev.disabled = idx <= 0;
    $btnNext.disabled = idx >= state.modalAssets.length - 1;
    renderModalDotsAndCounter();
  }

  function openModal(item){
    state.modalAssets = (item.assets && item.assets.length) ? item.assets.slice() : [];
    state.modalIndex = 0;
    state.modalCaption = item.caption || "";
    renderModalAsset();
    $modal.classList.add("open");
    $modal.setAttribute("aria-hidden","false");
  }

  function closeModalFn(){
    $modal.classList.remove("open");
    $modal.setAttribute("aria-hidden","true");
    $modalMedia.innerHTML = "";
    $modalCaption.textContent = "";
    $modalDots.innerHTML = "";
    $modalCounter.textContent = "";
    $modalPager.style.display = "none";
    state.modalAssets = [];
    state.modalIndex = 0;
    state.modalCaption = "";
  }

  $btnPrev.onclick = () => { if (state.modalIndex > 0){ state.modalIndex--; renderModalAsset(); } };
  $btnNext.onclick = () => { if (state.modalIndex < state.modalAssets.length - 1){ state.modalIndex++; renderModalAsset(); } };
  $zonePrev.onclick = $btnPrev.onclick;
  $zoneNext.onclick = $btnNext.onclick;
  $modal.onclick = e => { if (e.target === $modal) closeModalFn(); };
  $modalClose.onclick = closeModalFn;

  document.addEventListener("keydown", e => {
    if (!$modal.classList.contains("open")) return;
    if (e.key === "Escape") closeModalFn();
    if (e.key === "ArrowLeft") $btnPrev.click();
    if (e.key === "ArrowRight") $btnNext.click();
  });

  (function setupSwipe(){
    let startX = null;
    let isTouching = false;

    function onStart(e){
      isTouching = true;
      startX = (e.touches ? e.touches[0].clientX : e.clientX);
    }
    function onEnd(e){
      if (!isTouching || startX == null) return;
      const endX = (e.changedTouches ? e.changedTouches[0].clientX : e.clientX);
      const diff = endX - startX;
      const threshold = 40;

      if (Math.abs(diff) > threshold){
        if (diff < 0) $btnNext.click();
        else $btnPrev.click();
      }
      isTouching = false;
      startX = null;
    }

    $mediaWrap.addEventListener("touchstart", onStart, {passive:true});
    $mediaWrap.addEventListener("touchend", onEnd);

    let mouseDown = false;
    $mediaWrap.addEventListener("mousedown", e => { mouseDown = true; onStart(e); });
    $mediaWrap.addEventListener("mouseup", e => { if (!mouseDown) return; mouseDown = false; onEnd(e); });
    $mediaWrap.addEventListener("mouseleave", () => { mouseDown = false; startX = null; });
  })();

  function updateViewButtons(){
    $btnViewGrid.classList.toggle("active", state.viewMode === "grid");
    $btnViewReels.classList.toggle("active", state.viewMode === "reels");
    $btnViewDrafts.classList.toggle("active", state.viewMode === "drafts");
  }

  function applyReadonlyRules(){
    if (READONLY){
      $btnViewDrafts.style.display = "none";
      if (state.viewMode === "drafts") state.viewMode = "grid";
    } else {
      $btnViewDrafts.style.display = "inline-flex";
    }
  }

  $btnViewGrid.onclick = () => { state.viewMode = "grid"; state.visibleCount = BASE_LIMIT; updateViewButtons(); renderGrid(); };
  $btnViewReels.onclick = () => { state.viewMode = "reels"; state.visibleCount = BASE_LIMIT; updateViewButtons(); renderGrid(); };
  $btnViewDrafts.onclick = () => { if (READONLY) return; state.viewMode = "drafts"; state.visibleCount = BASE_LIMIT; updateViewButtons(); renderGrid(); };

  $btnMore.onclick = () => {
    const totalFiltered = (state.items || []).filter(passFilters).length;
    state.visibleCount = Math.min(totalFiltered, (state.visibleCount || BASE_LIMIT) + 6);
    renderGrid();
  };
  $btnLess.onclick = () => { state.visibleCount = BASE_LIMIT; renderGrid(); };

  function handleRefresh(){
    state.selectedPlatform = null;
    state.selectedStatus = null;
    state.visibleCount = BASE_LIMIT;
    state.viewMode = "grid";
    $labelPlatforms.textContent = "All Platforms";
    $labelStatus.textContent = "All Status";
    setPillDots();
    openPanel(null);
    load();
  }

  $btnRefresh.onclick = handleRefresh;
  if ($aiRefresh){
    $aiRefresh.addEventListener("click", function(e){
      e.stopPropagation();
      handleRefresh();
    });
  }

  // ===== Toolbar / Panel interactions =====

  // Filter button = “focus filters”: closes menu + any dropdowns (no weird opens)
  $btnFilter.onclick = (e) => {
    e.stopPropagation();
    openPanel(null);
  };

  $togglePlatforms.onclick = (e) => {
    e.stopPropagation();
    const isOpen = $ddPlatforms.classList.contains("open");
    openPanel(isOpen ? null : "platforms");
  };

  $toggleStatus.onclick = (e) => {
    e.stopPropagation();
    const isOpen = $ddStatus.classList.contains("open");
    openPanel(isOpen ? null : "status");
  };

  $btnMenu.onclick = (e) => {
    e.stopPropagation();
    const isOpen = $menu.classList.contains("open");
    openPanel(isOpen ? null : "menu");
  };

  // click outside closes everything
  document.addEventListener("click", () => openPanel(null));

  // ===== Menu rows =====
  $rowBio.onclick = () => toggleBio();
  $switchBio.onclick = (e) => { e.stopPropagation(); toggleBio(); };

  $rowDrag.onclick = () => setDragEnabled(!state.dragEnabled);
  $switchDrag.onclick = (e) => { e.stopPropagation(); setDragEnabled(!state.dragEnabled); };

  $optDate.onclick = () => setOrderMode("date");
  $optCustom.onclick = () => setOrderMode("custom");

  $btnCancelOrder.onclick = (e) => { e.stopPropagation(); cancelDragMode(); };
  $btnSaveOrder.onclick = (e) => { e.stopPropagation(); saveDragMode(); };

  // Drag-mode floating icon click: re-enter drag mode if enabled + custom
  $btnDragMode.onclick = (e) => {
    e.stopPropagation();
    if (READONLY) return;
    if (!state.dragEnabled) return;
    if (state.orderMode !== "custom") state.orderMode = "custom";
    startDragMode();
    openPanel(null);
  };

  async function load(){
    renderSkeleton();
    try{
      const res = await fetch("/api/grid");
      const data = await res.json();
      if (!data || !data.ok){
        console.error("Grid error:", data && data.error);
        $grid.innerHTML = '<div class="card card-placeholder">Error loading grid</div>';
        $btnMore.style.display = "none";
        $btnLess.style.display = "none";
        $modalPager.style.display = "none";
        return;
      }

      state.dbId = data.dbId || null;

      state.items = (data.items || []).map((it, idx) => ({
        ...it,
        _order: typeof it._order === "number" ? it._order : idx,
        _id: it._id || it.id || it.pageId || it.notionId || `local-${idx}`
      }));

      // Restore showBio
      try{ state.showBio = (localStorage.getItem("showBio") || "true") === "true"; }catch(e){ state.showBio = true; }
      setSwitch($switchBio, state.showBio);

      // Restore dragEnabled + orderMode
      try{ state.dragEnabled = (localStorage.getItem("dragEnabled") || "false") === "true"; }catch(e){ state.dragEnabled = false; }
      setSwitch($switchDrag, state.dragEnabled);

      try{ state.orderMode = localStorage.getItem("orderMode") || "date"; }catch(e){ state.orderMode = "date"; }
      if (state.orderMode !== "date" && state.orderMode !== "custom") state.orderMode = "date";
      if (!state.dragEnabled) state.orderMode = "date";

      // Load saved order
      loadSavedOrder();

      // dragMode must start false on load
      state.dragMode = false;
      applyBodyModes();
      updateOrderMenuUI();

      state.bio = data.bio || null;
      renderBio();
      renderMenus();

      state.visibleCount = BASE_LIMIT;
      applyReadonlyRules();
      updateViewButtons();
      renderGrid();
      setPillDots();
      openPanel(null);
      $modalPager.style.display = "none";
    }catch(e){
      console.error("Load error:", e);
      $grid.innerHTML = '<div class="card card-placeholder">Error loading grid</div>';
      $btnMore.style.display = "none";
      $btnLess.style.display = "none";
      $modalPager.style.display = "none";
    }
  }

  load();
</script>
</body>
</html>
